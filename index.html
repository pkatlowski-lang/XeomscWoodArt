<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- ANTI-CACHE META TAGS -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>Xeomsc FusionArt - Grawerowanie Laserowe i Drewno</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Konfiguracja Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        wood: {
                            100: '#fef3c7',
                            500: '#d97706',
                            600: '#b45309',
                            800: '#92400e',
                            900: '#78350f',
                        },
                        stone: {
                            50: '#fafaf9',
                            800: '#292524',
                            900: '#1c1917',
                            950: '#0c0a09',
                        }
                    },
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.8s ease-out forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            scroll-behavior: smooth;
        }
        
        .gradient-text {
            background: linear-gradient(to right, #b45309, #d97706);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        
        .white-outline-text {
            text-shadow: 
                -1px -1px 0 #fff,  
                 1px -1px 0 #fff,
                -1px  1px 0 #fff,
                 1px  1px 0 #fff,
                 0px  0px 8px rgba(255,255,255,0.8);
        }

        .text-outline {
            text-shadow: 
                -1px -1px 2px rgba(0,0,0,0.4),  
                 1px -1px 2px rgba(0,0,0,0.4),
                -1px  1px 2px rgba(0,0,0,0.4),
                 1px  1px 2px rgba(0,0,0,0.4),
                 0px  2px 10px rgba(0,0,0,0.6);
        }

        .hero-bg {
            background-color: #fafaf9;
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23d6d3d1' fill-opacity='0.2' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E");
        }
        
        /* UKRYWANIE ELEMENTÓW PRZEGLĄDARKI I OPERA GX */
        video::-webkit-media-controls { display: none !important; }
        video::-webkit-media-controls-enclosure { display: none !important; }
        .rgx-button-wrapper, .rgx-button-overlay, .custom-button-wrapper, .button-container, 
        #video-detach-button, #send-by-qrcode-button, #lucid-mode-button, #skip-button,
        div[class*="rgx"], div[class*="custom-button"] {
            display: none !important; opacity: 0 !important; pointer-events: none !important;
        }

        .fade-in { animation: fadeIn 0.6s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .hero-slide { position: absolute; inset: 0; opacity: 0; transition: opacity 1.5s ease-in-out; z-index: 1; }
        .hero-slide.active { opacity: 1; z-index: 10; }

        .admin-controls { display: none !important; }
        body.is-admin .admin-controls { display: flex !important; }
        body.is-admin #navbar { top: 58px; }

        .admin-sidebar-item.active { background-color: #b45309; color: white; border-right: 4px solid #fff; }
        #admin-panel.hidden { display: none !important; }

        .calc-input {
            background: #1c1917; border: 1px solid #444; color: white; padding: 0.75rem;
            border-radius: 0.5rem; width: 100%; outline: none; transition: border-color 0.2s;
        }
        .calc-input:focus { border-color: #d97706; background: #292524; }
        
        .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-online { background-color: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .status-offline { background-color: #ef4444; }
        .status-connecting { background-color: #eab308; animation: pulse 1s infinite; }

        #toast-notification {
            position: fixed; bottom: 20px; right: 20px; background-color: #22c55e; color: white;
            padding: 1rem 1.5rem; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: translateY(100px); opacity: 0; transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 9999; display: flex; align-items: center; gap: 10px; font-weight: bold;
        }
        #toast-notification.show { transform: translateY(0); opacity: 1; }

        #error-banner {
            display: none; background-color: #ef4444; color: white; padding: 10px; text-align: center;
            font-size: 12px; font-weight: bold; position: fixed; bottom: 0; left: 0; width: 100%; z-index: 10000;
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .thumb-active { border: 2px solid #b45309; opacity: 1; transform: scale(1.05); }

        /* STYL WIADOMOŚCI */
        .message-row-wrapper {
            background-color: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 0.75rem;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        
        .message-row-header {
            transition: background-color 0.2s;
            cursor: pointer;
            padding: 1rem;
            display: grid;
            grid-template-columns: 2fr 3fr 4fr 3fr 1fr;
            gap: 10px;
            align-items: center;
        }
        .message-row-header:hover {
            background-color: rgba(255,255,255,0.08);
        }
        .message-unread-header {
            background-color: rgba(239, 68, 68, 0.1);
            font-weight: bold;
            border-left: 4px solid #ef4444;
        }
        
        /* Akordeon wiadomości */
        .msg-body-wrapper {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out, padding 0.5s;
            opacity: 0;
            background-color: rgba(0,0,0,0.2);
        }
        .msg-body-wrapper.open {
            opacity: 1;
            max-height: 2000px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            display: inline-block;
            letter-spacing: 0.05em;
        }
        .status-new { background: #ef4444; color: white; }
        .status-read { background: #d97706; color: white; }
        .status-inprogress { background: #eab308; color: black; }
        .status-replied { background: #3b82f6; color: white; }
        .status-closed { background: #22c55e; color: white; }
        .status-archive { background: #57534e; color: #d6d3d1; }
        
        .notification-badge {
            position: absolute; top: -6px; right: -6px; background-color: #ef4444; color: white;
            font-size: 10px; font-weight: bold; height: 18px; min-width: 18px; padding: 0 4px;
            border-radius: 9px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 10;
        }

        .custom-order-item:hover img { transform: scale(1.05); }
        .selected-category-border { border-color: #b45309 !important; box-shadow: 0 0 15px rgba(180, 83, 9, 0.3); }
        
        /* Modal Potwierdzenia */
        #confirm-modal {
            background-color: rgba(0,0,0,0.85); backdrop-filter: blur(4px);
        }

        /* DRAG CURSORS - NOWE STYLE DO PRZESUWANIA */
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; user-select: none; }
    </style>
</head>
<body class="text-stone-800 bg-stone-50">

    <!-- Toast Notification -->
    <div id="toast-notification">
        <i class="fa-solid fa-check-circle"></i>
        <span id="toast-text">Zapisano zmiany w chmurze!</span>
    </div>

    <!-- Error Banner for Diagnostics -->
    <div id="error-banner"></div>

    <!-- Custom Confirm Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-[6000] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full text-center animate-fade-in border-2 border-wood-600">
            <div class="mb-4 text-wood-600 text-4xl"><i class="fa-solid fa-circle-question"></i></div>
            <h3 class="text-xl font-bold mb-2">Jesteś pewien?</h3>
            <p id="confirm-text" class="text-stone-500 mb-6 text-sm">Tej operacji nie można cofnąć.</p>
            <div class="flex gap-3 justify-center">
                <button onclick="closeConfirm(false)" class="px-6 py-2 rounded-xl bg-stone-200 text-stone-700 font-bold hover:bg-stone-300 transition">Nie</button>
                <button onclick="closeConfirm(true)" class="px-6 py-2 rounded-xl bg-wood-600 text-white font-bold hover:bg-wood-700 transition shadow-lg">Tak, usuń</button>
            </div>
        </div>
    </div>

    <!-- 1. EKRAN LOGOWANIA -->
    <div id="login-screen" class="fixed inset-0 z-[9999] bg-stone-900/98 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-10 text-center animate-fade-in border-4 border-wood-600">
            <div class="mb-8 inline-flex items-center justify-center w-20 h-20 rounded-full bg-wood-100 text-wood-600 text-4xl shadow-inner">
                <i class="fa-solid fa-user-lock"></i>
            </div>
            <h2 class="text-3xl font-bold text-stone-900 mb-2">Panel Administratora</h2>
            <p class="text-stone-500 mb-8 text-sm">Zaloguj się, aby zarządzać treścią strony</p>
            
            <form onsubmit="event.preventDefault(); handleLogin();" class="space-y-5 text-left">
                <div>
                    <label class="block text-xs font-bold text-stone-500 uppercase mb-1 ml-1">Login</label>
                    <input type="text" id="login-user" class="w-full bg-stone-50 border border-stone-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-wood-500 outline-none transition font-medium" placeholder="Login">
                </div>
                <div>
                    <label class="block text-xs font-bold text-stone-500 uppercase mb-1 ml-1">Hasło</label>
                    <input type="password" id="login-pass" class="w-full bg-stone-50 border border-stone-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-wood-500 outline-none transition font-medium" placeholder="Hasło">
                </div>
                <div id="login-error" class="text-red-500 text-sm hidden text-center font-bold bg-red-50 p-2 rounded-lg">
                    <i class="fa-solid fa-circle-exclamation mr-1"></i> Błędny login lub hasło!
                </div>
                <button type="submit" class="w-full bg-wood-600 text-white py-4 rounded-xl font-bold hover:bg-wood-700 transition shadow-lg transform active:scale-95">Zaloguj się</button>
            </form>
            <button onclick="exitLogin()" class="mt-8 text-sm text-stone-400 hover:text-wood-600 underline transition">Wróć do strony głównej</button>
        </div>
    </div>

    <!-- 2. PASEK ADMINA -->
    <div id="admin-bar" class="hidden bg-stone-900 text-white text-sm py-2 px-6 fixed top-0 w-full z-[150] flex justify-between items-center shadow-lg border-b border-wood-600">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 px-3 py-1 bg-white/5 rounded-full border border-white/10" id="db-status-indicator">
                <div id="status-dot" class="status-dot status-connecting"></div>
                <span id="status-text" class="text-xs font-bold uppercase tracking-wider text-stone-400">Łączenie...</span>
            </div>
            <button onclick="toggleAdminPanel()" class="relative bg-wood-600 hover:bg-wood-500 text-white px-4 py-2 rounded-lg text-xs font-bold transition flex items-center gap-2 shadow-md">
                <i class="fa-solid fa-gears"></i> Panel CMS
                <span id="msg-count-bar" class="notification-badge hidden">0</span>
            </button>
        </div>
        <button onclick="handleLogout()" class="text-stone-400 hover:text-white font-medium transition flex items-center gap-2 text-xs">
            <i class="fa-solid fa-power-off"></i> Wyloguj
        </button>
    </div>

    <!-- 3. NAWIGACJA STRONY -->
    <nav class="fixed w-full z-50 bg-white/95 backdrop-blur-md shadow-sm transition-all duration-300 top-0 h-24 flex items-center border-b border-stone-100" id="navbar">
        <div class="max-w-7xl mx-auto px-6 w-full flex justify-between items-center">
            <a href="#" onclick="goHome(); window.scrollTo(0,0);" class="text-2xl font-bold text-stone-900 tracking-tight flex items-center gap-2 group transition-colors" id="nav-logo">
                <div class="bg-wood-600 text-white w-10 h-10 rounded-lg flex items-center justify-center text-xl shadow-lg group-hover:bg-wood-700 transition">
                    <i class="fa-solid fa-bolt"></i>
                </div>
                <span>Xeomsc <span class="text-wood-600" id="nav-logo-accent">FusionArt</span></span>
            </a>
            
            <div class="hidden md:flex space-x-10 items-center font-medium text-stone-600" id="nav-links">
                <a href="#home" onclick="goHome()" class="hover:text-wood-600 transition">Start</a>
                <a href="#about" onclick="goHome()" class="hover:text-wood-600 transition">O ofercie</a>
                <a href="#portfolio" onclick="goHome()" class="hover:text-wood-600 transition">Nasze Produkty</a>
                <a href="#custom-orders" onclick="goHome()" class="hover:text-wood-600 transition">Zrealizowane Zlecenia</a>
                <a href="#contact" onclick="goHome()" class="px-6 py-3 bg-wood-600 text-white rounded-full hover:bg-wood-800 transition shadow-lg font-bold">Kontakt</a>
            </div>

            <div class="md:hidden flex items-center">
                <button onclick="toggleMobileMenu()" class="text-stone-800 p-2 text-2xl transition-colors" id="mobile-menu-btn">
                    <i class="fa-solid fa-bars"></i>
                </button>
            </div>
        </div>
        
        <div class="md:hidden hidden absolute top-24 left-0 w-full bg-white border-t border-stone-100 shadow-xl" id="mobile-menu">
            <div class="flex flex-col p-4 space-y-2 text-stone-800">
                <a href="#home" onclick="goHome(); toggleMobileMenu();" class="px-4 py-3 rounded-xl hover:bg-stone-50 font-medium">Start</a>
                <a href="#about" onclick="goHome(); toggleMobileMenu();" class="px-4 py-3 rounded-xl hover:bg-stone-50 font-medium">O ofercie</a>
                <a href="#portfolio" onclick="goHome(); toggleMobileMenu();" class="px-4 py-3 rounded-xl hover:bg-stone-50 font-medium">Nasze Produkty</a>
                <a href="#custom-orders" onclick="goHome(); toggleMobileMenu();" class="px-4 py-3 rounded-xl hover:bg-stone-50 font-medium">Zrealizowane Zlecenia</a>
                <a href="#contact" onclick="goHome(); toggleMobileMenu();" class="px-4 py-3 rounded-xl bg-wood-50 text-wood-700 font-bold">Kontakt</a>
            </div>
        </div>
    </nav>

    <!-- 4. KONTENER GŁÓWNY -->
    <div id="main-content" class="pt-24 transition-all duration-300">
        <!-- Hero Section -->
        <section id="home" class="relative h-[calc(100vh-6rem)] flex items-center hero-bg overflow-hidden pt-10">
            <div class="absolute inset-0 z-0" id="hero-carousel-container">
                <div class="w-full h-full bg-stone-200 animate-pulse"></div>
            </div>
            
            <div class="absolute inset-0 bg-stone-900/40 z-10"></div>
            
            <div class="max-w-7xl mx-auto px-6 relative z-20 w-full">
                <div class="w-full md:w-2/3 lg:w-1/2 text-center md:text-left">
                    <span class="inline-block py-2 px-5 rounded-full bg-wood-100/90 backdrop-blur text-wood-800 text-xs font-bold mb-6 border border-wood-200 uppercase tracking-widest shadow-lg">
                        Pracownia Grawerska
                    </span>
                    <h1 class="text-5xl md:text-7xl font-bold leading-tight mb-6 text-white text-outline">
                        <span id="hero-title-main">Precyzja Lasera,<br>Ciepło</span> 
                        <span id="hero-title-accent" class="gradient-text white-outline-text">Drewna</span>.
                    </h1>
                    <p id="hero-desc" class="text-lg md:text-xl text-white/90 mb-10 max-w-lg mx-auto md:mx-0 font-medium text-outline leading-relaxed">
                        Witaj w Xeomsc FusionArt. Tworzymy spersonalizowane dekoracje, pamiątki oraz gadżety reklamowe z duszą.
                    </p>
                    <div class="flex flex-wrap gap-4 justify-center md:justify-start">
                        <a href="#portfolio" class="px-10 py-4 bg-wood-600 text-white rounded-full hover:bg-wood-700 hover:scale-105 transform transition shadow-xl font-bold text-center">
                            Zobacz nasze prace
                        </a>
                    </div>
                </div>
            </div>
        </section>

        <!-- Oferta -->
        <section id="about" class="py-24 bg-white">
            <div class="max-w-7xl mx-auto px-6 text-center">
                <h2 class="text-4xl font-bold mb-4 text-stone-900">Co oferujemy?</h2>
                <div class="w-24 h-1.5 bg-wood-600 mx-auto rounded-full mb-16 opacity-80"></div>
                <div id="about-grid" class="grid grid-cols-1 md:grid-cols-3 gap-10"></div>
            </div>
        </section>

        <!-- Nasze Produkty -->
        <section id="portfolio" class="py-24 bg-stone-50">
            <div class="max-w-7xl mx-auto px-6 text-center">
                <h2 class="text-4xl font-bold mb-4 text-stone-900">Nasze Produkty</h2>
                <div class="w-24 h-1.5 bg-wood-600 mx-auto rounded-full mb-16 opacity-80"></div>
                
                <p class="text-stone-400 text-sm font-bold uppercase tracking-widest mb-4">Krok 1: Wybierz Kategorię</p>
                <div class="relative group mb-12" onmouseenter="window.stopAutoScroll()" onmouseleave="window.startAutoScroll()">
                    <button onclick="scrollCategories(-1)" class="absolute left-0 top-1/2 -translate-y-1/2 z-10 bg-wood-600 text-white w-12 h-12 rounded-full shadow-lg opacity-0 group-hover:opacity-100 transition-opacity disabled:opacity-0 hover:bg-wood-700 -ml-4 flex items-center justify-center">
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                    <!-- Dodano cursor-grab -->
                    <div id="main-categories-grid" class="flex overflow-x-auto gap-8 pb-8 snap-x snap-mandatory hide-scrollbar text-left px-4 cursor-grab"></div>
                    <button onclick="scrollCategories(1)" class="absolute right-0 top-1/2 -translate-y-1/2 z-10 bg-wood-600 text-white w-12 h-12 rounded-full shadow-lg opacity-0 group-hover:opacity-100 transition-opacity disabled:opacity-0 hover:bg-wood-700 -mr-4 flex items-center justify-center">
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>
                </div>

                <div id="sub-categories-container" class="hidden animate-fade-in border-t border-stone-200 pt-12">
                    <p class="text-wood-600 text-sm font-bold uppercase tracking-widest mb-4">Krok 2: Wybierz Podkategorię</p>
                    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                        <h3 id="selected-cat-title" class="text-3xl font-bold text-stone-800"></h3>
                        <!-- NOWY PRZYCISK: ZOBACZ WSZYSTKIE -->
                        <button id="btn-see-all-subcats" onclick="" class="text-wood-600 hover:text-wood-800 font-bold text-sm flex items-center gap-2 group">
                            Zobacz wszystkie podkategorie <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition"></i>
                        </button>
                    </div>
                    
                    <!-- ZMODYFIKOWANA SEKCJA PODKATEGORII Z PRZYCISKAMI -->
                    <div class="relative group">
                        <!-- Przycisk Lewy Podkategorie -->
                        <button onclick="scrollSubCategories(-1)" class="absolute left-0 top-1/2 -translate-y-1/2 z-10 bg-stone-800 text-white w-12 h-12 rounded-full shadow-lg opacity-0 group-hover:opacity-100 transition-opacity disabled:opacity-0 hover:bg-wood-600 -ml-4 flex items-center justify-center">
                            <i class="fa-solid fa-chevron-left"></i>
                        </button>
                        
                        <!-- Kontener Podkategorii z cursor-grab - USUNIĘTO justify-center, DODANO px-4 -->
                        <div id="sub-categories-grid" class="flex overflow-x-auto gap-6 pb-6 snap-x snap-mandatory hide-scrollbar text-left px-4 cursor-grab"></div>
                        
                        <!-- Przycisk Prawy Podkategorie -->
                        <button onclick="scrollSubCategories(1)" class="absolute right-0 top-1/2 -translate-y-1/2 z-10 bg-stone-800 text-white w-12 h-12 rounded-full shadow-lg opacity-0 group-hover:opacity-100 transition-opacity disabled:opacity-0 hover:bg-wood-600 -mr-4 flex items-center justify-center">
                            <i class="fa-solid fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Zlecenia -->
        <section id="custom-orders" class="py-24 bg-white">
            <div class="max-w-7xl mx-auto px-6 text-center">
                <h2 class="text-4xl font-bold mb-4 text-stone-900">Zrealizowane Zlecenia na zamówienie</h2>
                <div class="w-24 h-1.5 bg-wood-600 mx-auto rounded-full mb-12 opacity-80"></div>
                
                <div class="relative group">
                    <button onclick="scrollCustomOrders(-1)" class="absolute left-0 top-1/2 -translate-y-1/2 z-10 bg-stone-800 text-white w-12 h-12 rounded-full shadow-lg opacity-0 group-hover:opacity-100 transition-opacity disabled:opacity-0 hover:bg-wood-600 -ml-4 flex items-center justify-center">
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                    <!-- Dodano cursor-grab -->
                    <div id="custom-orders-carousel" class="flex overflow-x-auto gap-6 pb-8 snap-x snap-mandatory hide-scrollbar text-left px-2 cursor-grab"></div>
                    <button onclick="scrollCustomOrders(1)" class="absolute right-0 top-1/2 -translate-y-1/2 z-10 bg-stone-800 text-white w-12 h-12 rounded-full shadow-lg opacity-0 group-hover:opacity-100 transition-opacity disabled:opacity-0 hover:bg-wood-600 -mr-4 flex items-center justify-center">
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>
                </div>

                <div class="mt-8">
                    <button onclick="openCustomOrdersGallery()" class="px-8 py-3 bg-stone-100 text-stone-600 rounded-full hover:bg-stone-200 hover:text-wood-600 transition font-bold shadow-sm inline-flex items-center gap-2">
                        <i class="fa-solid fa-grid-2"></i> Zobacz pełną galerię zleceń
                    </button>
                </div>
            </div>
        </section>

        <!-- Kontakt -->
        <section id="contact" class="py-24 bg-stone-50">
            <div class="max-w-5xl mx-auto px-6 text-center">
                 <h2 class="text-4xl font-bold mb-6">Kontakt i Wycena</h2>
                 <p id="contact-desc" class="mb-16 text-stone-500 text-lg max-w-2xl mx-auto">Masz pomysł na projekt? Napisz do mnie, a pomogę Ci go zrealizować i przygotuję indywidualną wycenę. Odpowiadam najszybciej jak to możliwe.</p>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div onclick="openGeneralContactModal()" class="flex flex-col items-center justify-center p-10 bg-white rounded-[2.5rem] border border-stone-100 hover:border-wood-600 hover:bg-wood-50 cursor-pointer transition group shadow-sm transform hover:-translate-y-1">
                        <span class="text-xs font-bold text-stone-400 uppercase tracking-widest mb-4 group-hover:text-wood-600 transition">Kliknij</span>
                        <div class="w-20 h-20 bg-stone-50 rounded-full shadow-md flex items-center justify-center text-wood-600 text-3xl mb-6 group-hover:scale-110 group-hover:bg-wood-600 group-hover:text-white transition duration-300">
                            <i class="fa-solid fa-envelope"></i>
                        </div>
                        <span class="font-bold text-2xl text-stone-900 group-hover:text-wood-700 transition">Wyślij Wiadomość</span>
                    </div>

                    <div class="flex flex-col items-center justify-center p-10 bg-white rounded-[2.5rem] border border-stone-100 hover:border-wood-200 transition group shadow-sm">
                        <div class="w-16 h-16 bg-stone-50 rounded-full shadow-md flex items-center justify-center text-wood-600 text-2xl mb-6 group-hover:scale-110 transition">
                            <i class="fa-solid fa-phone"></i>
                        </div>
                        <span class="text-sm font-bold text-stone-400 uppercase tracking-widest mb-2">Zadzwoń</span>
                        <span id="contact-phone" class="font-bold text-2xl text-stone-900">+48 123 456 789</span>
                    </div>
                 </div>
            </div>
        </section>

        <!-- Stopka Główna -->
        <footer class="bg-stone-950 text-stone-600 py-16 text-center text-sm border-t border-white/5">
            <div class="max-w-7xl mx-auto px-6 space-y-6 flex flex-col md:flex-row justify-between items-center">
                <div class="text-left">
                    <h2 class="text-xl font-bold text-white mb-1">Xeomsc <span class="text-wood-600">FusionArt</span></h2>
                    <p id="footer-slogan" class="text-xs mb-4">Pasja. Precyzja. Drewno.</p>
                    
                    <div class="flex flex-wrap gap-4 text-xs font-bold uppercase tracking-wider text-stone-500">
                        <button onclick="openLegal('privacy')" class="hover:text-wood-600 transition">Polityka Prywatności</button>
                        <span class="text-stone-700">|</span>
                        <button onclick="openLegal('terms')" class="hover:text-wood-600 transition">Regulamin</button>
                    </div>
                </div>
                <p id="footer-copyright">&copy; 2024 Xeomsc FusionArt. Wszelkie prawa zastrzeżone.</p>
            </div>
        </footer>
    </div>

    <!-- WIDOKI DYNAMICZNE (Podstrony) -->
    
    <!-- Widok Produktów w Podkategorii -->
    <div id="subcategory-view" class="hidden min-h-screen bg-white pt-20 pb-20 fade-in fixed inset-0 z-[105] overflow-y-auto">
        <!-- LOGO HEADER -->
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between border-b border-stone-100 mb-8 bg-white/95 backdrop-blur sticky top-0 z-50">
            <a href="#" onclick="goHome(); window.scrollTo(0,0);" class="text-xl font-bold text-stone-900 tracking-tight flex items-center gap-2 group transition-colors">
                <div class="bg-wood-600 text-white w-8 h-8 rounded-lg flex items-center justify-center text-lg shadow-lg group-hover:bg-wood-700 transition"><i class="fa-solid fa-bolt"></i></div>
                <span>Xeomsc <span class="text-wood-600">FusionArt</span></span>
            </a>
            <button onclick="goHome()" class="text-stone-400 hover:text-stone-800 transition"><i class="fa-solid fa-xmark text-2xl"></i></button>
        </div>

        <div class="max-w-7xl mx-auto px-6 pb-20">
            <button onclick="window.goBackToSubcategoryList()" class="mb-10 flex items-center gap-3 text-stone-500 hover:text-wood-600 font-bold transition group bg-stone-50 px-6 py-3 rounded-full w-fit">
                <i class="fa-solid fa-arrow-left group-hover:-translate-x-1 transition"></i> Wróć do listy kategorii
            </button>
            <h2 id="subcategory-title" class="text-5xl font-bold text-stone-900 mb-12 border-b border-stone-100 pb-6">Wybierz produkt</h2>
            <div id="subcategory-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-10"></div>
        </div>

        <!-- Stopka w widoku podkategorii -->
        <footer class="bg-stone-950 text-stone-600 py-16 text-center text-sm border-t border-white/5 mt-20">
            <div class="max-w-7xl mx-auto px-6 space-y-6 flex flex-col md:flex-row justify-between items-center">
                <div class="text-left">
                    <h2 class="text-xl font-bold text-white mb-1">Xeomsc <span class="text-wood-600">FusionArt</span></h2>
                    <p class="text-xs mb-4">Pasja. Precyzja. Drewno.</p>
                    <div class="flex flex-wrap gap-4 text-xs font-bold uppercase tracking-wider text-stone-500">
                        <button onclick="openLegal('privacy')" class="hover:text-wood-600 transition">Polityka Prywatności</button>
                        <span class="text-stone-700">|</span>
                        <button onclick="openLegal('terms')" class="hover:text-wood-600 transition">Regulamin</button>
                    </div>
                </div>
                <p>&copy; 2024 Xeomsc FusionArt. Wszelkie prawa zastrzeżone.</p>
            </div>
        </footer>
    </div>

    <!-- Widok WSZYSTKICH Podkategorii -->
    <div id="subcategories-full-view" class="hidden min-h-screen bg-white pt-20 pb-20 fade-in fixed inset-0 z-[104] overflow-y-auto">
        <!-- LOGO HEADER -->
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between border-b border-stone-100 mb-8 bg-white/95 backdrop-blur sticky top-0 z-50">
            <a href="#" onclick="goHome(); window.scrollTo(0,0);" class="text-xl font-bold text-stone-900 tracking-tight flex items-center gap-2 group transition-colors">
                <div class="bg-wood-600 text-white w-8 h-8 rounded-lg flex items-center justify-center text-lg shadow-lg group-hover:bg-wood-700 transition"><i class="fa-solid fa-bolt"></i></div>
                <span>Xeomsc <span class="text-wood-600">FusionArt</span></span>
            </a>
            <button onclick="goHome()" class="text-stone-400 hover:text-stone-800 transition"><i class="fa-solid fa-xmark text-2xl"></i></button>
        </div>

        <div class="max-w-7xl mx-auto px-6 pb-20">
            <button onclick="goHome()" class="mb-10 flex items-center gap-3 text-stone-500 hover:text-wood-600 font-bold transition group bg-stone-50 px-6 py-3 rounded-full w-fit">
                <i class="fa-solid fa-arrow-left group-hover:-translate-x-1 transition"></i> Wróć do strony głównej
            </button>
            <h2 id="subcategories-full-title" class="text-5xl font-bold text-stone-900 mb-4">Wszystkie kategorie</h2>
            <p class="text-stone-500 mb-12">Wybierz kategorię, aby zobaczyć dostępne produkty.</p>
            <div id="subcategories-full-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
        </div>

        <!-- Stopka w widoku wszystkich podkategorii -->
        <footer class="bg-stone-950 text-stone-600 py-16 text-center text-sm border-t border-white/5 mt-20">
            <div class="max-w-7xl mx-auto px-6 space-y-6 flex flex-col md:flex-row justify-between items-center">
                <div class="text-left">
                    <h2 class="text-xl font-bold text-white mb-1">Xeomsc <span class="text-wood-600">FusionArt</span></h2>
                    <p class="text-xs mb-4">Pasja. Precyzja. Drewno.</p>
                    <div class="flex flex-wrap gap-4 text-xs font-bold uppercase tracking-wider text-stone-500">
                        <button onclick="openLegal('privacy')" class="hover:text-wood-600 transition">Polityka Prywatności</button>
                        <span class="text-stone-700">|</span>
                        <button onclick="openLegal('terms')" class="hover:text-wood-600 transition">Regulamin</button>
                    </div>
                </div>
                <p>&copy; 2024 Xeomsc FusionArt. Wszelkie prawa zastrzeżone.</p>
            </div>
        </footer>
    </div>

    <!-- Widok Produktu -->
    <div id="gallery-view" class="hidden min-h-screen bg-white pt-20 pb-20 fade-in fixed inset-0 z-[110] overflow-y-auto">
        <!-- LOGO HEADER -->
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between border-b border-stone-100 mb-8 bg-white/95 backdrop-blur sticky top-0 z-50">
            <a href="#" onclick="goHome(); window.scrollTo(0,0);" class="text-xl font-bold text-stone-900 tracking-tight flex items-center gap-2 group transition-colors">
                <div class="bg-wood-600 text-white w-8 h-8 rounded-lg flex items-center justify-center text-lg shadow-lg group-hover:bg-wood-700 transition"><i class="fa-solid fa-bolt"></i></div>
                <span>Xeomsc <span class="text-wood-600">FusionArt</span></span>
            </a>
            <button onclick="goHome()" class="text-stone-400 hover:text-stone-800 transition"><i class="fa-solid fa-xmark text-2xl"></i></button>
        </div>
        
        <!-- Zawartość Produktu (dynamiczna) -->
        <div class="max-w-7xl mx-auto px-6 grid grid-cols-1 lg:grid-cols-2 gap-12 items-start pb-20">
            <!-- Lewa: Zdjęcia -->
            <div class="space-y-4">
                <!-- ZMIANA: object-cover na object-contain, aby pokazać całe zdjęcie -->
                <div class="aspect-square bg-stone-100 rounded-3xl overflow-hidden border border-stone-100 shadow-lg cursor-zoom-in relative group flex items-center justify-center" onclick="openLightbox(window.currentImgIndex)">
                    <img id="main-product-img" src="" class="w-full h-full object-contain transition duration-500">
                    <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition flex items-center justify-center pointer-events-none">
                        <i class="fa-solid fa-magnifying-glass-plus text-white text-4xl opacity-0 group-hover:opacity-100 transition transform scale-75 group-hover:scale-100 drop-shadow-md"></i>
                    </div>
                </div>
                <!-- Miniaturki z przewijaniem -->
                <div class="relative group">
                    <div id="product-thumbnails" class="flex gap-4 overflow-x-auto pb-2 hide-scrollbar px-1 snap-x snap-mandatory"></div>
                    <div class="absolute inset-y-0 right-0 w-12 bg-gradient-to-l from-white to-transparent pointer-events-none"></div>
                </div>
            </div>

            <!-- Prawa: Info -->
            <div class="space-y-8 lg:sticky lg:top-32">
                 <div>
                     <button id="back-to-sub-btn" class="mb-6 flex items-center gap-2 text-stone-400 hover:text-wood-600 text-sm font-bold uppercase tracking-wider transition">
                        <i class="fa-solid fa-arrow-left"></i> Powrót do listy
                     </button>
                     <h2 id="prod-title" class="text-4xl md:text-5xl font-bold text-stone-900 mb-2 leading-tight"></h2>
                     <div class="flex items-center gap-4 text-sm font-mono text-stone-400">
                        <span id="prod-code"></span>
                     </div>
                 </div>

                 <div class="flex items-baseline gap-4 border-b border-stone-100 pb-8">
                     <span id="prod-price" class="text-4xl font-bold text-wood-600"></span>
                 </div>

                 <div class="prose prose-stone text-stone-600 leading-relaxed">
                     <h3 class="text-stone-900 font-bold uppercase text-xs tracking-widest mb-2">Opis produktu</h3>
                     <p id="prod-desc"></p>
                 </div>

                 <div class="pt-6 space-y-4">
                     <button id="ask-btn" class="w-full bg-wood-600 text-white py-5 rounded-2xl font-bold text-lg hover:bg-wood-700 hover:-translate-y-1 transition shadow-xl flex items-center justify-center gap-3">
                        <i class="fa-regular fa-comments"></i> Zapytaj o ten produkt
                     </button>
                     <p class="text-center text-xs text-stone-400">
                        <i class="fa-solid fa-shield-halved mr-1"></i> Gwarancja jakości i bezpieczna dostawa
                     </p>
                 </div>
            </div>
        </div>
    </div>

    <!-- NOWY WIDOK: DOKUMENTY PRAWNE (Polityka / Regulamin) -->
    <div id="legal-view" class="hidden min-h-screen bg-white pt-20 pb-20 fade-in fixed inset-0 z-[130] overflow-y-auto">
        <!-- LOGO HEADER -->
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between border-b border-stone-100 mb-8 bg-white/95 backdrop-blur sticky top-0 z-50">
            <a href="#" onclick="goHome(); window.scrollTo(0,0);" class="text-xl font-bold text-stone-900 tracking-tight flex items-center gap-2 group transition-colors">
                <div class="bg-wood-600 text-white w-8 h-8 rounded-lg flex items-center justify-center text-lg shadow-lg group-hover:bg-wood-700 transition"><i class="fa-solid fa-scale-balanced"></i></div>
                <span>Xeomsc <span class="text-wood-600">Legal</span></span>
            </a>
            <button onclick="closeLegal()" class="text-stone-400 hover:text-stone-800 transition"><i class="fa-solid fa-xmark text-2xl"></i></button>
        </div>

        <div class="max-w-4xl mx-auto px-6">
            <button onclick="closeLegal()" class="mb-10 flex items-center gap-3 text-stone-500 hover:text-wood-600 font-bold transition group bg-stone-50 px-6 py-3 rounded-full w-fit">
                <i class="fa-solid fa-arrow-left group-hover:-translate-x-1 transition"></i> Powrót
            </button>
            <h2 id="legal-title" class="text-4xl font-bold text-stone-900 mb-8 border-b border-stone-100 pb-6"></h2>
            <div id="legal-content" class="text-stone-600 text-lg leading-relaxed whitespace-pre-wrap font-light text-justify"></div>
        </div>
    </div>

    <!-- PEŁNA GALERIA ZLECEŃ -->
    <div id="custom-orders-full-view" class="hidden min-h-screen bg-white pt-20 pb-20 fade-in fixed inset-0 z-[120] overflow-y-auto">
         <!-- LOGO HEADER -->
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between border-b border-stone-100 mb-8 bg-white/95 backdrop-blur sticky top-0 z-50">
            <a href="#" onclick="goHome(); window.scrollTo(0,0);" class="text-xl font-bold text-stone-900 tracking-tight flex items-center gap-2 group transition-colors">
                <div class="bg-wood-600 text-white w-8 h-8 rounded-lg flex items-center justify-center text-lg shadow-lg group-hover:bg-wood-700 transition"><i class="fa-solid fa-bolt"></i></div>
                <span>Xeomsc <span class="text-wood-600">FusionArt</span></span>
            </a>
            <button onclick="goHome()" class="text-stone-400 hover:text-stone-800 transition"><i class="fa-solid fa-xmark text-2xl"></i></button>
        </div>

        <div class="max-w-7xl mx-auto px-6 pb-20">
            <button onclick="goHome()" class="mb-10 flex items-center gap-3 text-stone-500 hover:text-wood-600 font-bold transition group bg-stone-50 px-6 py-3 rounded-full w-fit">
                <i class="fa-solid fa-arrow-left group-hover:-translate-x-1 transition"></i> Powrót do strony głównej
            </button>
            <h2 class="text-5xl font-bold text-stone-900 mb-4">Katalog Zrealizowanych Zleceń</h2>
            <p class="text-stone-500 mb-12 text-lg">Przegląd indywidualnych projektów wykonanych dla naszych klientów.</p>
            <div id="custom-orders-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
        </div>

        <!-- Stopka w galerii zleceń -->
        <footer class="bg-stone-950 text-stone-600 py-16 text-center text-sm border-t border-white/5 mt-20">
            <div class="max-w-7xl mx-auto px-6 space-y-6 flex flex-col md:flex-row justify-between items-center">
                <div class="text-left">
                    <h2 class="text-xl font-bold text-white mb-1">Xeomsc <span class="text-wood-600">FusionArt</span></h2>
                    <p class="text-xs mb-4">Pasja. Precyzja. Drewno.</p>
                    <div class="flex flex-wrap gap-4 text-xs font-bold uppercase tracking-wider text-stone-500">
                        <button onclick="openLegal('privacy')" class="hover:text-wood-600 transition">Polityka Prywatności</button>
                        <span class="text-stone-700">|</span>
                        <button onclick="openLegal('terms')" class="hover:text-wood-600 transition">Regulamin</button>
                    </div>
                </div>
                <p>&copy; 2024 Xeomsc FusionArt. Wszelkie prawa zastrzeżone.</p>
            </div>
        </footer>
    </div>

    <!-- LIGHTBOX -->
    <div id="lightbox" class="fixed inset-0 z-[5000] bg-stone-950/95 hidden flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 cursor-pointer backdrop-blur-md" onclick="closeLightbox()">
        <button class="absolute top-6 right-6 text-white/50 hover:text-white transition z-[5010] p-4" onclick="closeLightbox()">
            <i class="fa-solid fa-xmark text-4xl"></i>
        </button>
        <button onclick="event.stopPropagation(); changeLightboxImage(-1)" class="absolute left-4 top-1/2 -translate-y-1/2 text-white/30 hover:text-white p-6 transition z-[5010] hidden md:block hover:bg-white/5 rounded-full">
            <i class="fa-solid fa-chevron-left text-4xl"></i>
        </button>
        <div class="relative max-w-7xl max-h-screen w-full flex flex-col items-center justify-center p-2" onclick="event.stopPropagation()">
            <img id="lightbox-img" src="" alt="Powiększenie" class="rounded-lg shadow-2xl max-h-[95vh] object-contain transition-all duration-300">
            <p id="lightbox-counter" class="text-white/40 mt-4 text-sm font-mono">1 / 5</p>
            
            <!-- NOWE: Przycisk zoomu w lightboxie dla załączników -->
            <button id="lightbox-zoom-toggle" onclick="event.stopPropagation(); window.toggleLightboxZoom()" class="hidden absolute bottom-[-40px] right-0 bg-stone-800 text-white px-4 py-2 rounded-lg text-xs font-bold border border-white/20 hover:bg-stone-700 transition">
                <i class="fa-solid fa-expand mr-2"></i> Rozmiar rzeczywisty
            </button>
        </div>
        <button onclick="event.stopPropagation(); changeLightboxImage(1)" class="absolute right-4 top-1/2 -translate-y-1/2 text-white/30 hover:text-white p-6 transition z-[5010] hidden md:block hover:bg-white/5 rounded-full">
            <i class="fa-solid fa-chevron-right text-4xl"></i>
        </button>
    </div>

    <!-- MODAL FORMULARZA KONTAKTOWEGO -->
    <div id="contact-modal" class="fixed inset-0 z-[3000] bg-stone-900/80 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden animate-fade-in relative flex flex-col max-h-[90vh]">
            <div class="bg-wood-600 p-6 text-white flex justify-between items-center shrink-0">
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <i class="fa-regular fa-paper-plane"></i> Formularz zapytania
                </h3>
                <button onclick="closeContactModal()" class="text-white/70 hover:text-white transition p-2">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto">
                <div>
                    <label class="block text-xs font-bold text-stone-500 uppercase mb-1 ml-1">Twoje Imię</label>
                    <input type="text" id="contact-name" class="w-full bg-stone-50 border border-stone-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-wood-500 outline-none transition" placeholder="np. Jan Kowalski">
                </div>
                <div>
                    <label class="block text-xs font-bold text-stone-500 uppercase mb-1 ml-1">Twój Email</label>
                    <!-- DODANO AUTOCOMPLETE OFF -->
                    <input type="email" id="contact-email-input" class="w-full bg-stone-50 border border-stone-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-wood-500 outline-none transition" placeholder="np. jan@example.com" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                </div>
                
                <div id="product-codes-section" class="border-t border-b border-stone-100 py-4 my-2 hidden">
                    <label class="block text-xs font-bold text-wood-600 uppercase mb-2 ml-1">Kod Produktu</label>
                    <div id="product-codes-container" class="space-y-3">
                        <div class="flex gap-2">
                            <input type="text" id="code-input-0" class="w-full bg-stone-100 border border-stone-200 rounded-xl px-4 py-2 text-sm font-mono text-stone-700" readonly>
                        </div>
                    </div>
                </div>

                <div id="contact-upload-section" class="border-t border-b border-stone-100 py-4 my-2 hidden">
                    <label class="block text-xs font-bold text-wood-600 uppercase mb-2 ml-1">Załącz zdjęcie (Opcjonalnie, max 1MB)</label>
                    <div class="relative">
                        <input type="file" id="contact-file-input" accept="image/*" class="w-full text-sm text-stone-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-wood-50 file:text-wood-700 hover:file:bg-wood-100 cursor-pointer">
                    </div>
                    <p class="text-[10px] text-stone-400 mt-1">Zdjęcie zostanie wysłane do administratora.</p>
                </div>

                <div>
                    <label class="block text-xs font-bold text-stone-500 uppercase mb-1 ml-1">Treść Wiadomości / Zapytanie</label>
                    <textarea id="contact-message" class="w-full bg-stone-50 border border-stone-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-wood-500 outline-none transition h-32 resize-none" placeholder="Dzień dobry, chciałbym zapytać o..."></textarea>
                </div>
            </div>
            <div class="p-6 border-t border-stone-100 bg-stone-50 shrink-0">
                <button onclick="submitContactForm()" id="submit-contact-btn" class="w-full bg-wood-600 text-white py-4 rounded-xl font-bold hover:bg-wood-700 transition shadow-lg transform active:scale-95 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-paper-plane"></i> Wyślij zapytanie
                </button>
            </div>
        </div>
    </div>

    <!-- 6. PANEL ADMINISTRATORA (CMS) -->
    <div id="admin-panel" class="fixed inset-0 z-[2000] bg-stone-950/60 backdrop-blur-md hidden items-center justify-center p-4 sm:p-8">
        <div class="bg-stone-900 text-white w-full max-w-7xl h-full max-h-[90vh] rounded-[2rem] overflow-hidden flex flex-col md:flex-row shadow-2xl border border-white/10 ring-1 ring-white/5">
             <div class="w-full md:w-72 bg-black/40 border-r border-white/5 p-8 flex flex-col shrink-0">
                 <div class="mb-10">
                    <h2 class="text-xl font-bold text-white flex items-center gap-3">
                        <i class="fa-solid fa-screwdriver-wrench text-wood-500"></i><span>CMS Panel</span>
                    </h2>
                 </div>
                 <nav class="space-y-3 flex-1 overflow-y-auto">
                    <button onclick="switchAdminView('messages')" id="btn-messages" class="admin-sidebar-item w-full text-left px-5 py-4 rounded-xl hover:bg-white/5 transition flex items-center gap-3 font-medium text-stone-400 hover:text-white"><i class="fa-solid fa-inbox w-6"></i> Wiadomości</button>
                    <button onclick="switchAdminView('content')" id="btn-content" class="admin-sidebar-item w-full text-left px-5 py-4 rounded-xl hover:bg-white/5 transition flex items-center gap-3 font-medium text-stone-400 hover:text-white"><i class="fa-solid fa-pen-to-square w-6"></i> Edycja Treści</button>
                    <button onclick="switchAdminView('hero-gallery')" id="btn-hero-gallery" class="admin-sidebar-item w-full text-left px-5 py-4 rounded-xl hover:bg-white/5 transition flex items-center gap-3 font-medium text-stone-400 hover:text-white"><i class="fa-solid fa-images w-6"></i> Karuzela Hero</button>
                    <div class="h-px bg-white/10 my-2"></div>
                    <button onclick="switchAdminView('categories')" id="btn-categories" class="admin-sidebar-item w-full text-left px-5 py-4 rounded-xl hover:bg-white/5 transition flex items-center gap-3 font-medium text-stone-400 hover:text-white"><i class="fa-solid fa-layer-group w-6"></i> Kategorie</button>
                    <button onclick="switchAdminView('subcategories')" id="btn-subcategories" class="admin-sidebar-item w-full text-left px-5 py-4 rounded-xl hover:bg-white/5 transition flex items-center gap-3 font-medium text-stone-400 hover:text-white"><i class="fa-solid fa-folder-tree w-6"></i> Podkategorie</button>
                    <button onclick="switchAdminView('products')" id="btn-products" class="admin-sidebar-item w-full text-left px-5 py-4 rounded-xl hover:bg-white/5 transition flex items-center gap-3 font-medium text-stone-400 hover:text-white"><i class="fa-solid fa-plus-circle w-6"></i> Dodaj Produkty</button>
                    <button onclick="switchAdminView('product-list')" id="btn-product-list" class="admin-sidebar-item w-full text-left px-5 py-4 rounded-xl hover:bg-white/5 transition flex items-center gap-3 font-medium text-stone-400 hover:text-white"><i class="fa-solid fa-list-ul w-6"></i> Lista Produktów</button>
                    <div class="h-px bg-white/10 my-2"></div>
                    <button onclick="switchAdminView('custom-orders')" id="btn-custom-orders" class="admin-sidebar-item w-full text-left px-5 py-4 rounded-xl hover:bg-white/5 transition flex items-center gap-3 font-medium text-stone-400 hover:text-white"><i class="fa-solid fa-camera-retro w-6"></i> Galeria Zleceń</button>
                    <!-- NOWY PRZYCISK: Kalkulator -->
                    <button onclick="switchAdminView('calculator')" id="btn-calculator" class="admin-sidebar-item w-full text-left px-5 py-4 rounded-xl hover:bg-white/5 transition flex items-center gap-3 font-medium text-stone-400 hover:text-white"><i class="fa-solid fa-calculator w-6"></i> Kalkulator Wyceny</button>
                 </nav>
                 <button onclick="toggleAdminPanel()" class="mt-6 py-3 text-stone-500 hover:text-white transition flex items-center gap-2 text-sm border-t border-white/10 justify-center"><i class="fa-solid fa-xmark"></i> Zamknij Panel</button>
             </div>
             <div id="admin-content-area" class="flex-1 overflow-y-auto p-8 md:p-12 bg-stone-900 relative">
                 <div id="view-messages" class="admin-view hidden space-y-6">
                    <h3 class="text-3xl font-bold">Skrzynka Odbiorcza</h3>
                    <div class="bg-black/20 rounded-xl overflow-hidden border border-white/10 min-h-[200px]">
                        <!-- Header tabeli -->
                        <div class="grid grid-cols-12 gap-2 p-4 bg-white/5 text-xs font-bold text-stone-400 uppercase tracking-wider border-b border-white/5">
                            <div class="col-span-2">Status</div>
                            <div class="col-span-3">Nadawca</div>
                            <div class="col-span-4">Email</div>
                            <div class="col-span-3 text-right">Data/Akcje</div>
                        </div>
                        <div id="messages-list" class="divide-y divide-white/5"></div>
                    </div>
                 </div>
                 <div id="view-content" class="admin-view hidden space-y-10">
                    <h3 class="text-3xl font-bold mb-6">Edycja Treści</h3>
                    <div class="space-y-6">
                        <div><label class="block text-xs font-bold text-stone-500 mb-2">Nagłówek Hero (Linia 1)</label><input id="edit-hero-main" class="calc-input"></div>
                        <div><label class="block text-xs font-bold text-stone-500 mb-2">Nagłówek Hero (Akcent)</label><input id="edit-hero-accent" class="calc-input text-wood-500"></div>
                        <div><label class="block text-xs font-bold text-stone-500 mb-2">Opis Hero</label><textarea id="edit-hero-desc" class="calc-input h-24"></textarea></div>
                        <div class="border-t border-white/5 pt-6"></div>
                        <div><label class="block text-xs font-bold text-stone-500 mb-2">Email Kontaktowy</label><input id="edit-contact-email" class="calc-input"></div>
                        <div><label class="block text-xs font-bold text-stone-500 mb-2">Telefon</label><input id="edit-contact-phone" class="calc-input"></div>
                        <div><label class="block text-xs font-bold text-stone-500 mb-2">Opis w sekcji Kontakt</label><textarea id="edit-contact-desc" class="calc-input h-24"></textarea></div>
                        
                        <!-- EDYCJA DOKUMENTÓW PRAWNYCH -->
                        <div class="border-t border-white/5 pt-6">
                            <h4 class="text-xl font-bold mb-4 text-wood-500">Dokumenty Prawne</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-stone-500 mb-2">Polityka Prywatności (Treść)</label>
                                    <textarea id="edit-privacy" class="calc-input h-48 font-mono text-xs"></textarea>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-stone-500 mb-2">Regulamin (Treść)</label>
                                    <textarea id="edit-terms" class="calc-input h-48 font-mono text-xs"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- NOWA SEKCJA: EDYCJA STOPKI -->
                        <div class="border-t border-white/5 pt-6">
                            <h4 class="text-xl font-bold mb-4 text-wood-500">Stopka</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-stone-500 mb-2">Slogan pod logo</label>
                                    <input id="edit-footer-slogan" class="calc-input" placeholder="np. Pasja. Precyzja. Drewno.">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-stone-500 mb-2">Tekst Copyright</label>
                                    <input id="edit-footer-copyright" class="calc-input" placeholder="np. &copy; 2024 Xeomsc...">
                                </div>
                            </div>
                        </div>

                        <div><label class="block text-xs font-bold text-stone-500 mb-2">Klucz API ImgBB (Opcjonalny - Hosting Zdjęć)</label><input id="edit-imgbb-key" type="password" class="calc-input" placeholder="Wklej API Key jeśli używasz"></div>
                        <button onclick="saveContentSettings()" class="bg-wood-600 hover:bg-wood-500 px-8 py-3 rounded-xl font-bold transition">Zapisz Zmiany</button>
                    </div>
                 </div>
                 <div id="view-hero-gallery" class="admin-view hidden space-y-8"></div>
                 <div id="view-categories" class="admin-view hidden space-y-8"></div>
                 <div id="view-subcategories" class="admin-view hidden space-y-8"></div>
                 <div id="view-products" class="admin-view hidden space-y-8"></div>
                 <div id="view-product-list" class="admin-view hidden space-y-8"></div>
                 <div id="view-custom-orders" class="admin-view hidden space-y-8">
                     <h3 class="text-3xl font-bold mb-6">Galeria Zleceń (Strona Główna)</h3>
                     <div class="bg-stone-800 p-6 rounded-3xl border border-white/5 mb-8">
                        <label class="block text-xs font-bold text-stone-500 uppercase mb-2">Dodaj linki do zdjęć (Każdy w nowej linii)</label>
                        <div id="custom-orders-input-container" class="space-y-2">
                             <input class="calc-input gallery-input" placeholder="Link do zdjęcia" oninput="window.addGalleryInput(this)">
                        </div>
                        <button onclick="saveCustomOrders()" class="bg-wood-600 hover:bg-wood-500 w-full py-3 rounded-xl font-bold transition mt-4">Zapisz Galerię</button>
                     </div>
                     <div id="admin-custom-orders-list" class="grid grid-cols-4 gap-4"></div>
                 </div>
                 
                 <!-- NOWY WIDOK: KALKULATOR WYCENY -->
                 <div id="view-calculator" class="admin-view hidden space-y-8">
                    <h3 class="text-3xl font-bold mb-6">Kalkulator Wyceny</h3>
                    <div class="bg-stone-800 p-8 rounded-3xl border border-white/5 max-w-2xl">
                        <div class="space-y-4">
                            <div><label class="text-xs uppercase font-bold text-stone-500 mb-1 block">Koszt Materiału (PLN)</label><input type="number" id="calc-material" class="calc-input" value="0"></div>
                            <div><label class="text-xs uppercase font-bold text-stone-500 mb-1 block">Czas Pracy Lasera (Minuty)</label><input type="number" id="calc-time" class="calc-input" value="0"></div>
                            <div><label class="text-xs uppercase font-bold text-stone-500 mb-1 block">Stawka za godzinę pracy (PLN)</label><input type="number" id="calc-rate" class="calc-input" value="120"></div>
                            <div><label class="text-xs uppercase font-bold text-stone-500 mb-1 block">Koszty dodatkowe (Projekt/Pakowanie) (PLN)</label><input type="number" id="calc-extra" class="calc-input" value="0"></div>
                            <div><label class="text-xs uppercase font-bold text-stone-500 mb-1 block">Marża (%)</label><input type="number" id="calc-margin" class="calc-input" value="30"></div>
                            
                            <button onclick="calculatePrice()" class="bg-wood-600 hover:bg-wood-500 w-full py-4 rounded-xl font-bold transition mt-6 text-lg">Oblicz Cenę</button>
                        </div>
                        
                        <div id="calc-result" class="mt-8 p-6 bg-black/40 rounded-2xl border border-white/10 hidden animate-fade-in text-center">
                            <p class="text-stone-400 text-sm uppercase font-bold mb-2">Sugerowana Cena Końcowa</p>
                            <div class="text-4xl font-bold text-wood-500" id="calc-final-price">0.00 PLN</div>
                            <div class="text-xs text-stone-500 mt-2">Koszt wytworzenia: <span id="calc-base-cost">0.00</span> PLN | Zysk: <span id="calc-profit">0.00</span> PLN</div>
                        </div>
                    </div>
                </div>

             </div>
        </div>
    </div>

    <!-- LOGIKA SYSTEMU -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, addDoc, collection, deleteDoc, updateDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        // KONFIGURACJA FIREBASE
        // ==========================================
        let manualConfig = {
          apiKey: "AIzaSyDeRtreUSAmNWvhZm2_Fkt9OcpWs07PrVw",
          authDomain: "xeomsc-a8edd.firebaseapp.com",
          projectId: "xeomsc-a8edd",
          storageBucket: "xeomsc-a8edd.firebasestorage.app",
          messagingSenderId: "43822805612",
          appId: "1:43822805612:web:d343653e47777d8ebf5e49"
        };
        const envConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const firebaseConfig = Object.keys(manualConfig).length > 0 ? manualConfig : envConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'xeomsc-fusionart';
        let db, auth, siteData = {};
        let isOnline = false;
        let lastError = "";
        let messageUnsubscribe = null; 
        
        let categoryAutoScroll = null;
        let customOrdersAutoScroll = null;
        
        window.currentLightboxImages = [];
        window.currentImgIndex = 0;
        window.selectedListCatId = null;
        window.selectedListSubId = null; 
        window.selectedListProdIndex = null;
        window.openMessageIds = new Set(); // Śledzenie otwartych wiadomości
        window.isZoomed = false; // Stan zoomu w lightboxie
        window.currentContactProductImage = null; // ZMIENNA DO PRZECHOWYWANIA URL ZDJĘCIA PRODUKTU
        
        // Modal Confirm logic
        let confirmCallback = null;

        // Status Map
        const STATUS_MAP = {
            'new': { label: 'Nowa', class: 'status-new' },
            'read': { label: 'Przeczytana', class: 'status-read' },
            'in-progress': { label: 'W trakcie', class: 'status-inprogress' },
            'replied': { label: 'Odp. wysłana', class: 'status-replied' },
            'closed': { label: 'Zrealizowane', class: 'status-closed' },
            'archive': { label: 'Archiwum', class: 'status-archive' }
        };

        // Dane domyślne
        const initialData = {
            heroItems: [{ id: 1, type: 'image', url: 'https://images.unsplash.com/photo-1622623363380-45c128919616?q=80&w=2070' }],
            categories: {},
            galleries: {},
            customOrders: [],
            imgbbKey: "",
            textContent: {
                hero: { main: "Precyzja Lasera,<br>Ciepło", accent: "Drewna", desc: "Witaj w Xeomsc FusionArt. Tworzymy spersonalizowane dekoracje, pamiątki oraz gadżety reklamowe z duszą." },
                aboutCards: [
                    { icon: "fa-solid fa-wand-magic-sparkles", title: "Grawerowanie", desc: "Niezwykle precyzyjne nanoszenie detali, logotypów i grafik na drewno, szkło, skórę i inne materiały." },
                    { icon: "fa-solid fa-scissors", title: "Precyzyjne Cięcie", desc: "Wycinanie skomplikowanych kształtów, liter przestrzennych, topperów i elementów dekoracyjnych ze sklejki." },
                    { icon: "fa-solid fa-gift", title: "Unikalne Prezenty", desc: "Personalizowane pamiątki na każdą okazję: śluby, chrzciny, jubileusze. Tworzone z myślą o Tobie." }
                ],
                contact: { email: "pkatlowski@gmail.com", phone: "+48 123 456 789", desc: "Masz pomysł na projekt? Napisz do mnie, a pomogę Ci go zrealizować i przygotuję indywidualną wycenę. Odpowiadam najszybciej jak to możliwe." },
                // DOKUMENTY PRAWNE (Teksty domyślne)
                legal: {
                    privacy: "Tu wpisz treść Polityki Prywatności...\n\n1. Administrator Danych\nAdministratorem danych jest Xeomsc FusionArt.\n\n2. Cele przetwarzania\nDane przetwarzane są w celu realizacji zamówień i kontaktu z klientem.",
                    terms: "Tu wpisz treść Regulaminu...\n\n1. Postanowienia ogólne\nNiniejszy regulamin określa zasady korzystania ze sklepu.\n\n2. Zamówienia\nZamówienia można składać poprzez formularz kontaktowy."
                },
                // NOWE: STOPKA
                footer: {
                    slogan: "Pasja. Precyzja. Drewno.",
                    copyright: "&copy; 2024 Xeomsc FusionArt. Wszelkie prawa zastrzeżone."
                }
            }
        };

        // --- POWIADOMIENIA UI ---
        window.showToast = (msg) => {
            const toast = document.getElementById('toast-notification');
            document.getElementById('toast-text').textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        };

        window.openConfirm = (text, callback) => {
            document.getElementById('confirm-text').textContent = text;
            document.getElementById('confirm-modal').classList.remove('hidden');
            confirmCallback = callback;
        };

        window.closeConfirm = (result) => {
            document.getElementById('confirm-modal').classList.add('hidden');
            if(confirmCallback && result) confirmCallback();
            confirmCallback = null;
        };

        // ==========================================
        // STANDARDOWA LOGIKA STRONY
        // ==========================================

        window.updateNavbar = () => {
            const navbar = document.getElementById('navbar');
            if(!navbar) return;
            if (window.scrollY > 50) { navbar.classList.remove('h-24'); navbar.classList.add('h-20'); } 
            else { navbar.classList.add('h-24'); navbar.classList.remove('h-20'); }
        };
        window.addEventListener('scroll', window.updateNavbar);
        
        // Funkcja obsługująca Drag to Scroll (Przesuwanie myszką)
        window.enableDragScroll = (elementId) => {
            const slider = document.getElementById(elementId);
            if(!slider) return;
            
            let isDown = false;
            let startX;
            let scrollLeft;

            slider.addEventListener('mousedown', (e) => {
                isDown = true;
                slider.classList.add('cursor-grabbing');
                slider.classList.remove('cursor-grab');
                // Wyłącz snap podczas przeciągania dla płynności
                slider.style.scrollSnapType = 'none';
                startX = e.pageX - slider.offsetLeft;
                scrollLeft = slider.scrollLeft;
                window.stopAutoScroll(); // Zatrzymaj auto-scroll podczas interakcji
            });

            slider.addEventListener('mouseleave', () => {
                isDown = false;
                slider.classList.remove('cursor-grabbing');
                slider.classList.add('cursor-grab');
                slider.style.scrollSnapType = 'x mandatory'; // Przywróć snap
                window.startAutoScroll(); // Wznów auto-scroll
            });

            slider.addEventListener('mouseup', () => {
                isDown = false;
                slider.classList.remove('cursor-grabbing');
                slider.classList.add('cursor-grab');
                slider.style.scrollSnapType = 'x mandatory';
                window.startAutoScroll();
            });

            slider.addEventListener('mousemove', (e) => {
                if(!isDown) return;
                e.preventDefault();
                const x = e.pageX - slider.offsetLeft;
                const walk = (x - startX) * 2; // Szybkość przewijania
                slider.scrollLeft = scrollLeft - walk;
            });
        };

        window.scrollCategories = (direction) => {
            const container = document.getElementById('main-categories-grid'); if(!container) return;
            const scrollAmount = window.innerWidth < 768 ? 320 : 420;
            
            // Logika pętli (360 stopni)
            // Jeśli idziemy w prawo i jesteśmy przy końcu -> skocz na początek
            if (direction === 1 && Math.ceil(container.scrollLeft + container.clientWidth) >= container.scrollWidth - 10) {
                container.scrollTo({ left: 0, behavior: 'smooth' }); 
            } 
            // Jeśli idziemy w lewo i jesteśmy na początku -> skocz na koniec
            else if (direction === -1 && container.scrollLeft <= 0) {
                container.scrollTo({ left: container.scrollWidth, behavior: 'smooth' }); 
            } else {
                container.scrollBy({ left: direction * scrollAmount, behavior: 'smooth' });
            }
        };

        // Nowa funkcja do przewijania podkategorii (z logiką 360)
        window.scrollSubCategories = (direction) => {
            const container = document.getElementById('sub-categories-grid'); if(!container) return;
            const scrollAmount = window.innerWidth < 768 ? 280 : 320;

            if (direction === 1 && Math.ceil(container.scrollLeft + container.clientWidth) >= container.scrollWidth - 10) {
                container.scrollTo({ left: 0, behavior: 'smooth' });
            } else if (direction === -1 && container.scrollLeft <= 0) {
                container.scrollTo({ left: container.scrollWidth, behavior: 'smooth' });
            } else {
                container.scrollBy({ left: direction * scrollAmount, behavior: 'smooth' });
            }
        };

        window.scrollCustomOrders = (direction) => {
            const container = document.getElementById('custom-orders-carousel'); if(!container) return;
            const scrollAmount = window.innerWidth < 768 ? 300 : 400;

            // Logika pętli (360 stopni)
            if (direction === 1 && Math.ceil(container.scrollLeft + container.clientWidth) >= container.scrollWidth - 10) {
                container.scrollTo({ left: 0, behavior: 'smooth' });
            } else if (direction === -1 && container.scrollLeft <= 0) {
                container.scrollTo({ left: container.scrollWidth, behavior: 'smooth' });
            } else {
                container.scrollBy({ left: direction * scrollAmount, behavior: 'smooth' });
            }
        };
        
        window.startAutoScroll = () => {
            window.stopAutoScroll();
            categoryAutoScroll = setInterval(() => { window.scrollCategories(1); }, 3000);
            customOrdersAutoScroll = setInterval(() => { window.scrollCustomOrders(1); }, 4000);
        };
        window.stopAutoScroll = () => { if(categoryAutoScroll) clearInterval(categoryAutoScroll); if(customOrdersAutoScroll) clearInterval(customOrdersAutoScroll); };
        
        // ZMIENNA DO ŚLEDZENIA AKTYWNEJ KATEGORII NA STRONIE GŁÓWNEJ
        window.activeMainCatId = null;

        function renderTexts() {
            if(!siteData.textContent || !siteData.textContent.aboutCards) { siteData.textContent = initialData.textContent; }
            
            // Zabezpieczenie brakujących obiektów (dla starszych danych)
            if(!siteData.textContent.legal) siteData.textContent.legal = initialData.textContent.legal;
            if(!siteData.textContent.footer) siteData.textContent.footer = initialData.textContent.footer;

            const t = siteData.textContent;
            if(document.getElementById('hero-title-main')) document.getElementById('hero-title-main').innerHTML = t.hero.main;
            if(document.getElementById('hero-title-accent')) document.getElementById('hero-title-accent').textContent = t.hero.accent;
            if(document.getElementById('hero-desc')) document.getElementById('hero-desc').textContent = t.hero.desc;
            if(document.getElementById('contact-email')) document.getElementById('contact-email').textContent = t.contact.email;
            if(document.getElementById('contact-phone')) document.getElementById('contact-phone').textContent = t.contact.phone;
            if(document.getElementById('contact-desc')) document.getElementById('contact-desc').textContent = t.contact.desc;

            // Render Stopki
            // ZMIEŃ WSZYSTKIE STOPKI
            document.querySelectorAll('[id="footer-slogan"]').forEach(el => el.textContent = t.footer.slogan);
            document.querySelectorAll('[id="footer-copyright"]').forEach(el => el.innerHTML = t.footer.copyright);

            const grid = document.getElementById('about-grid');
            if(grid && t.aboutCards) {
                grid.innerHTML = t.aboutCards.map(c => `
                    <div class="p-10 bg-stone-50 rounded-[2.5rem] border border-stone-100 hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 group">
                        <div class="w-20 h-20 bg-wood-100 text-wood-600 rounded-3xl flex items-center justify-center mx-auto mb-8 group-hover:bg-wood-600 group-hover:text-white transition-colors shadow-sm"><i class="${c.icon} text-3xl"></i></div>
                        <h3 class="font-bold text-2xl mb-4 text-stone-800">${c.title}</h3>
                        <p class="text-stone-500 leading-relaxed">${c.desc}</p>
                    </div>`).join('');
            }
        }

        function renderHero() {
            const container = document.getElementById('hero-carousel-container');
            if (!container || !siteData.heroItems) return;
            container.innerHTML = siteData.heroItems.map((it, idx) => `
                <div class="hero-slide ${idx === 0 ? 'active' : ''}">
                    ${it.type === 'image' ? `<img src="${it.url}" class="w-full h-full object-cover object-center">` : `<video src="${it.url}" class="w-full h-full object-cover object-center pointer-events-none" muted autoplay loop playsinline disablepictureinpicture disableremoteplayback></video>`}
                </div>`).join('');
            
            let cur = 0; const slides = document.querySelectorAll('.hero-slide');
            if(window.heroInterval) clearInterval(window.heroInterval);
            window.heroInterval = setInterval(() => {
                if (slides.length < 2) return; slides[cur].classList.remove('active');
                cur = (cur + 1) % slides.length; slides[cur].classList.add('active');
            }, 6000);
        }

        function renderMain() {
            const grid = document.getElementById('main-categories-grid');
            if (grid) {
                grid.innerHTML = '';
                const cats = siteData.categories || {};
                // SORTOWANIE KATEGORII GŁÓWNYCH PO POLU 'order' (JEŚLI BRAK, DOMYŚLNIE 9999 LUB KOLEJNOŚĆ W BAZIE)
                const visibleCategories = Object.entries(cats)
                    .filter(([, c]) => !c.isHidden)
                    .sort(([, a], [, b]) => {
                        const orderA = a.order !== undefined ? a.order : 9999;
                        const orderB = b.order !== undefined ? b.order : 9999;
                        return orderA - orderB;
                    });
                
                if (visibleCategories.length === 0) { grid.innerHTML = '<p class="text-stone-400 w-full text-center py-10">Brak widocznych kategorii.</p>'; } 
                else {
                    const createCardHTML = ([id, c]) => `
                        <div id="main-cat-${id}" class="group bg-white rounded-[2.5rem] overflow-hidden shadow-sm hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 cursor-pointer border border-stone-100 fade-in min-w-[320px] md:min-w-[400px] snap-center shrink-0 category-card-item">
                            <div class="h-72 overflow-hidden relative" onclick="window.selectMainCategory('${id}')">
                                <img src="${c.image || 'https://via.placeholder.com/400'}" class="w-full h-full object-cover group-hover:scale-105 transition duration-700 pointer-events-none">
                                <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-60 pointer-events-none"></div>
                                <div class="absolute bottom-6 left-8 text-white"><h3 class="font-bold text-2xl">${c.title}</h3></div>
                            </div>
                            <div class="p-8 flex justify-between items-center" onclick="window.selectMainCategory('${id}')">
                                <span class="text-stone-500 font-medium text-sm">Pokaż podkategorie</span>
                                <div class="w-10 h-10 rounded-full bg-stone-100 flex items-center justify-center text-stone-400 group-hover:bg-wood-600 group-hover:text-white transition"><i class="fa-solid fa-arrow-down"></i></div>
                            </div>
                        </div>`;
                    const allItems = visibleCategories.length < 3 ? [...visibleCategories, ...visibleCategories, ...visibleCategories] : visibleCategories;
                    allItems.forEach(item => { grid.innerHTML += createCardHTML(item); });
                }
                // Aktywuj drag dla kategorii głównych
                window.enableDragScroll('main-categories-grid');
            }

            const coContainer = document.getElementById('custom-orders-carousel');
            if(coContainer) {
                coContainer.innerHTML = '';
                const orders = siteData.customOrders || [];
                if (orders.length === 0) { document.getElementById('custom-orders').classList.add('hidden'); } 
                else {
                    document.getElementById('custom-orders').classList.remove('hidden');
                    // ZMIANA: object-contain w karuzeli zleceń + szare tło (bg-stone-100)
                    const createOrderHTML = (url, index) => `<div class="custom-order-item snap-center shrink-0 min-w-[280px] h-[280px] rounded-3xl overflow-hidden cursor-pointer shadow-md bg-stone-100 flex items-center justify-center" onclick="openCustomOrdersGallery(true, ${index})"><img src="${url}" onerror="this.src='https://via.placeholder.com/300?text=Błąd+Zdjecia'; this.onerror=null;" class="w-full h-full object-contain transition duration-500 hover:scale-105 pointer-events-none"></div>`;
                    const displayOrders = orders.length < 4 ? [...orders, ...orders] : orders;
                    displayOrders.forEach((url, index) => { coContainer.innerHTML += createOrderHTML(url, index % orders.length); });
                }
                // Aktywuj drag dla zleceń
                window.enableDragScroll('custom-orders-carousel');
            }
            
            // FIX: ODŚWIEŻ WIDOK PODKATEGORII JEŚLI JEST OTWARTY
            if(window.activeMainCatId && siteData.categories[window.activeMainCatId]) {
                window.selectMainCategory(window.activeMainCatId, true); // true = preventScroll
            }

            window.startAutoScroll();
        }

        window.selectMainCategory = (id, preventScroll = false) => {
            document.querySelectorAll('.category-card-item').forEach(el => el.classList.remove('selected-category-border', 'border-wood-600', 'ring-4', 'ring-wood-200'));
            const selectedCards = document.querySelectorAll(`#main-cat-${id}`);
            selectedCards.forEach(el => el.classList.add('selected-category-border', 'border-wood-600', 'ring-4', 'ring-wood-200'));

            const cat = siteData.categories[id]; if(!cat) return;
            
            // Zapisz aktywną kategorię
            window.activeMainCatId = id;

            const container = document.getElementById('sub-categories-container');
            const title = document.getElementById('selected-cat-title');
            const grid = document.getElementById('sub-categories-grid');
            const btnSeeAll = document.getElementById('btn-see-all-subcats');

            title.textContent = cat.title; grid.innerHTML = '';
            
            // Konfiguracja przycisku "Zobacz wszystkie"
            btnSeeAll.onclick = () => window.openFullSubcategoryList(id);

            const subs = cat.subs || {}; 
            
            // SORTOWANIE PODKATEGORII ALFABETYCZNIE
            const subKeys = Object.keys(subs).sort((a, b) => subs[a].title.localeCompare(subs[b].title, 'pl'));

            if(subKeys.length > 0) {
                // Wyświetl wszystkie podkategorie w karuzeli
                grid.innerHTML = subKeys.map(sid => {
                    const sub = subs[sid];
                    // FIX: DODANO ONERROR DO ZDJĘĆ
                    return `<div class="group bg-white rounded-[2rem] overflow-hidden shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300 cursor-pointer border border-stone-100 min-w-[280px] snap-center shrink-0" onclick="window.openSubcategoryView('${id}', '${sid}')">
                             <div class="h-48 overflow-hidden relative"><img src="${sub.image || 'https://via.placeholder.com/300'}" onerror="this.src='https://via.placeholder.com/300?text=Brak+Zdjecia'; this.onerror=null;" class="w-full h-full object-cover group-hover:scale-105 transition duration-700 pointer-events-none"></div>
                            <div class="p-5"><h3 class="font-bold text-lg text-stone-800 line-clamp-1 text-center">${sub.title}</h3><p class="text-xs text-stone-400 text-center mt-1">${sub.products ? sub.products.length : 0} produktów</p></div></div>`;
                }).join('');
            } else { grid.innerHTML = '<p class="text-stone-400 italic">Brak podkategorii.</p>'; }
            
            // Aktywuj drag dla podkategorii
            window.enableDragScroll('sub-categories-grid');

            container.classList.remove('hidden');
            
            // Scrollujemy tylko jeśli to nowa interakcja, a nie odświeżenie danych
            if (!preventScroll) {
                setTimeout(() => { container.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
            }
        };
        
        // NOWA FUNKCJA: Otwiera pełną siatkę podkategorii
        window.openFullSubcategoryList = (catId) => {
            const cat = siteData.categories[catId];
            if(!cat) return;
            
            const container = document.getElementById('subcategories-full-view');
            const title = document.getElementById('subcategories-full-title');
            const grid = document.getElementById('subcategories-full-grid');
            
            title.textContent = cat.title;
            grid.innerHTML = '';
            
            // Przechowujemy ID kategorii, aby wiedzieć gdzie wrócić z widoku produktów
            window.currentCatId = catId;
            
            const subs = cat.subs || {};
            
            // SORTOWANIE PODKATEGORII ALFABETYCZNIE
            const subKeys = Object.keys(subs).sort((a, b) => subs[a].title.localeCompare(subs[b].title, 'pl'));
            
             if(subKeys.length > 0) {
                grid.innerHTML = subKeys.map(sid => {
                    const sub = subs[sid];
                    // FIX: DODANO ONERROR DO ZDJĘĆ
                    return `<div class="bg-stone-50 rounded-[2rem] overflow-hidden border border-stone-100 hover:border-wood-200 transition group cursor-pointer shadow-sm hover:shadow-xl hover:-translate-y-1 duration-300 fade-in" onclick="window.openSubcategoryView('${catId}', '${sid}')">
                        <div class="h-64 overflow-hidden relative"><img src="${sub.image || 'https://via.placeholder.com/300'}" onerror="this.src='https://via.placeholder.com/300?text=Brak+Zdjecia'; this.onerror=null;" class="w-full h-full object-cover group-hover:scale-105 transition duration-700"></div>
                        <div class="p-6">
                            <h3 class="font-bold text-xl text-stone-800 line-clamp-1">${sub.title}</h3>
                            <p class="text-stone-500 mt-2">${sub.products ? sub.products.length : 0} produktów</p>
                        </div></div>`;
                }).join('');
            } else {
                grid.innerHTML = '<div class="col-span-full text-center py-20 opacity-50"><p class="text-stone-500 text-lg">Brak podkategorii.</p></div>';
            }
            
            // FIX: Ukrywanie widoku podkategorii (listy produktów)
            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('subcategory-view').classList.add('hidden'); // Ważne: ukryj listę produktów
            document.getElementById('gallery-view').classList.add('hidden');
            container.classList.remove('hidden');
            window.scrollTo(0,0);
        };

        window.openCustomOrdersGallery = (lightboxDirect = false, index = 0) => {
             const orders = siteData.customOrders || []; if(orders.length === 0) return;
             window.currentLightboxImages = orders.map(url => ({ src: url }));
             if(lightboxDirect) { window.openLightbox(index); } 
             else {
                 const grid = document.getElementById('custom-orders-grid');
                 // ZMIANA: object-contain w pełnej galerii zleceń + tło
                 grid.innerHTML = orders.map((url, i) => `<div class="aspect-square rounded-2xl overflow-hidden cursor-pointer shadow-sm hover:shadow-xl transition group bg-stone-100 flex items-center justify-center" onclick="openLightbox(${i})"><img src="${url}" class="w-full h-full object-contain group-hover:scale-105 transition duration-500"></div>`).join('');
                 document.getElementById('main-content').classList.add('hidden');
                 document.getElementById('custom-orders-full-view').classList.remove('hidden');
                 window.scrollTo(0,0);
             }
        };

        window.openCategoryView = (id) => { window.selectMainCategory(id); };

        window.openSubcategoryView = (catId, subId) => {
            const cat = siteData.categories[catId];
            if(!cat || !cat.subs || !cat.subs[subId]) return;
            const sub = cat.subs[subId];
            document.getElementById('subcategory-title').textContent = sub.title;
            const grid = document.getElementById('subcategory-grid');
            
            // Przechowywanie ID dla przycisku powrotu w widoku produktu
            window.currentCatId = catId;
            window.currentSubId = subId;

            if(grid) {
                grid.innerHTML = '';
                const products = sub.products || [];
                if (products.length > 0) {
                    grid.innerHTML = products.map((prod, index) => {
                        if (prod.isHidden) return ''; 
                        return `<div class="bg-stone-50 rounded-[2rem] overflow-hidden border border-stone-100 hover:border-wood-200 transition group cursor-pointer shadow-sm hover:shadow-xl hover:-translate-y-1 duration-300 fade-in" onclick="window.openGallery('${catId}', '${subId}', ${index})" style="animation-delay: ${index * 50}ms">
                            <div class="h-64 overflow-hidden relative"><img src="${prod.image || 'https://via.placeholder.com/300'}" class="w-full h-full object-cover group-hover:scale-105 transition duration-700"></div>
                            <div class="p-6"><h3 class="font-bold text-xl text-stone-800 line-clamp-1">${prod.title}</h3><div class="flex justify-between items-center mt-2"><p class="text-wood-600 font-bold text-lg">${prod.price || 'Wycena'} PLN</p></div></div></div>`;
                    }).join('');
                } else { grid.innerHTML = '<div class="col-span-full text-center py-20 opacity-50"><div class="text-6xl mb-4 text-stone-300"><i class="fa-solid fa-box-open"></i></div><p class="text-stone-500 text-lg">Brak produktów.</p></div>'; }
            }
            
            // FIX: Ukrywanie innych widoków przy powrocie
            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('subcategories-full-view').classList.add('hidden'); 
            document.getElementById('gallery-view').classList.add('hidden'); // Ważne: ukryj widok produktu
            document.getElementById('subcategory-view').classList.remove('hidden');
            window.scrollTo(0,0);
        };
        
        // Funkcja powrotu z listy produktów (subcategory-view) do listy podkategorii (full-view)
        window.goBackToSubcategoryList = () => {
             if(window.currentCatId) {
                 window.openFullSubcategoryList(window.currentCatId);
             } else {
                 window.goHome();
             }
        };
        
        // NOWA FUNKCJA: Otwiera pełną siatkę podkategorii
        window.openFullSubcategoryList = (catId) => {
            const cat = siteData.categories[catId];
            if(!cat) return;
            
            const container = document.getElementById('subcategories-full-view');
            const title = document.getElementById('subcategories-full-title');
            const grid = document.getElementById('subcategories-full-grid');
            
            title.textContent = cat.title;
            grid.innerHTML = '';
            
            // Przechowujemy ID kategorii, aby wiedzieć gdzie wrócić z widoku produktów
            window.currentCatId = catId;
            
            const subs = cat.subs || {};
            // SORTOWANIE PODKATEGORII ALFABETYCZNIE
            const subKeys = Object.keys(subs).sort((a, b) => subs[a].title.localeCompare(subs[b].title, 'pl'));
            
             if(subKeys.length > 0) {
                grid.innerHTML = subKeys.map(sid => {
                    const sub = subs[sid];
                    return `<div class="bg-stone-50 rounded-[2rem] overflow-hidden border border-stone-100 hover:border-wood-200 transition group cursor-pointer shadow-sm hover:shadow-xl hover:-translate-y-1 duration-300 fade-in" onclick="window.openSubcategoryView('${catId}', '${sid}')">
                        <div class="h-64 overflow-hidden relative"><img src="${sub.image || 'https://via.placeholder.com/300'}" class="w-full h-full object-cover group-hover:scale-105 transition duration-700"></div>
                        <div class="p-6">
                            <h3 class="font-bold text-xl text-stone-800 line-clamp-1">${sub.title}</h3>
                            <p class="text-stone-500 mt-2">${sub.products ? sub.products.length : 0} produktów</p>
                        </div></div>`;
                }).join('');
            } else {
                grid.innerHTML = '<div class="col-span-full text-center py-20 opacity-50"><p class="text-stone-500 text-lg">Brak podkategorii.</p></div>';
            }
            
            // FIX: Ukrywanie widoku podkategorii (listy produktów)
            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('subcategory-view').classList.add('hidden'); // Ważne: ukryj listę produktów
            document.getElementById('gallery-view').classList.add('hidden');
            container.classList.remove('hidden');
            window.scrollTo(0,0);
        };

        window.openGallery = (catId, subId, prodIndex) => {
            const cat = siteData.categories[catId];
            if(!cat || !cat.subs || !cat.subs[subId]) return;
            const sub = cat.subs[subId]; const product = sub.products[prodIndex]; if (!product) return;

            document.getElementById('prod-title').textContent = product.title;
            document.getElementById('prod-code').textContent = product.code ? `Kod: ${product.code}` : 'Kod: ---';
            document.getElementById('prod-price').textContent = product.price || '--- PLN';
            document.getElementById('prod-desc').textContent = product.desc || 'Brak opisu.';
            
            const askBtn = document.getElementById('ask-btn');
            const codeToPass = product.code || '';
            const imageToPass = product.image || ''; // Pobieramy zdjęcie produktu
            
            // Przekazujemy zdjęcie do funkcji modala
            askBtn.onclick = () => window.openContactModal(codeToPass, imageToPass);
            
            // ZMIANA: Przycisk powrotu cofa do podkategorii
            document.getElementById('back-to-sub-btn').onclick = () => window.openSubcategoryView(catId, subId);
            
            const galleryData = siteData.galleries[product.id] || { images: [] };
            const allImages = [ { src: product.image, isCover: true }, ...galleryData.images ];
            window.currentLightboxImages = allImages;
            window.currentImgIndex = 0;

            const mainImgEl = document.getElementById('main-product-img');
            mainImgEl.src = allImages[0].src;

            const thumbsContainer = document.getElementById('product-thumbnails');
            thumbsContainer.innerHTML = '';
            if(allImages.length > 1) {
                allImages.forEach((img, i) => {
                    const thumb = document.createElement('img');
                    // ZMIANA: Miniatury też object-contain i białe tło
                    thumb.src = img.src; 
                    thumb.className = `w-20 h-20 rounded-xl object-contain bg-stone-100 cursor-pointer hover:opacity-100 transition shadow-sm border border-stone-200 snap-center shrink-0 ${i === 0 ? 'thumb-active' : 'opacity-60'}`;
                    thumb.onclick = () => { window.updateMainImage(i); };
                    thumbsContainer.appendChild(thumb);
                });
            } else { thumbsContainer.innerHTML = '<span class="text-xs text-stone-400">Brak dodatkowych zdjęć.</span>'; }
            document.getElementById('subcategory-view').classList.add('hidden');
            document.getElementById('gallery-view').classList.remove('hidden'); 
            window.scrollTo(0,0);
        };

        window.updateMainImage = (index) => {
            window.currentImgIndex = index;
            const mainImg = document.getElementById('main-product-img');
            const images = window.currentLightboxImages;
            if(images[index]) {
                mainImg.style.opacity = '0.5';
                setTimeout(() => { mainImg.src = images[index].src; mainImg.style.opacity = '1'; }, 150);
                const thumbs = document.getElementById('product-thumbnails').children;
                for(let i=0; i<thumbs.length; i++) {
                    if(i === index) { thumbs[i].classList.add('thumb-active'); thumbs[i].classList.remove('opacity-60'); } 
                    else { thumbs[i].classList.remove('thumb-active'); thumbs[i].classList.add('opacity-60'); }
                }
            }
        };

        window.delHero = (i) => { window.openConfirm("Usunąć ten slajd?", () => { siteData.heroItems.splice(i,1); saveData(); renderHeroAdmin(); renderHero(); }); };
        window.delCat = (k) => { window.openConfirm("Usunąć kategorię i jej produkty?", () => { delete siteData.categories[k]; saveData(); renderCategoriesAdmin(); renderMain(); }); };
        
        window.openLightbox = (index = 0) => { 
            const lb = document.getElementById('lightbox'); const imgEl = document.getElementById('lightbox-img'); const counterEl = document.getElementById('lightbox-counter');
            window.currentImgIndex = index; const images = window.currentLightboxImages;
            // Ukryj przycisk zoomu dla zwykłej galerii (chyba że chcemy go wszędzie, ale tutaj skupiamy się na załącznikach)
            document.getElementById('lightbox-zoom-toggle').classList.add('hidden');
            
            if(images.length > 0 && images[index]) {
                imgEl.src = images[index].src; counterEl.textContent = `${index + 1} / ${images.length}`;
                imgEl.classList.remove('max-h-none', 'max-w-none'); // Reset zoomu
                imgEl.classList.add('max-h-[95vh]', 'object-contain');
                window.isZoomed = false;
                
                lb.classList.remove('hidden'); setTimeout(() => { lb.classList.replace('opacity-0','opacity-100'); }, 10);
            }
        };

        // NOWA FUNKCJA DO PODGLĄDU ZAŁĄCZNIKA WIADOMOŚCI
        window.openMessageLightbox = (url) => {
            window.currentLightboxImages = [{ src: url }];
            window.currentImgIndex = 0;
            const lb = document.getElementById('lightbox');
            const imgEl = document.getElementById('lightbox-img');
            const counterEl = document.getElementById('lightbox-counter');
            const zoomBtn = document.getElementById('lightbox-zoom-toggle');
            
            imgEl.src = url;
            counterEl.textContent = "Załącznik";
            
            // Reset zoomu
            imgEl.classList.remove('max-h-none', 'max-w-none');
            imgEl.classList.add('max-h-[95vh]', 'object-contain');
            window.isZoomed = false;
            zoomBtn.innerHTML = '<i class="fa-solid fa-expand mr-2"></i> Rozmiar rzeczywisty';
            
            // Pokaż przycisk zoomu
            zoomBtn.classList.remove('hidden');
            
            lb.classList.remove('hidden');
            setTimeout(() => { lb.classList.replace('opacity-0','opacity-100'); }, 10);
        };

        window.toggleLightboxZoom = () => {
            const imgEl = document.getElementById('lightbox-img');
            const btn = document.getElementById('lightbox-zoom-toggle');
            
            if(window.isZoomed) {
                // Wróć do dopasowania
                imgEl.classList.remove('max-h-none', 'max-w-none');
                imgEl.classList.add('max-h-[95vh]', 'object-contain');
                btn.innerHTML = '<i class="fa-solid fa-expand mr-2"></i> Rozmiar rzeczywisty';
                window.isZoomed = false;
            } else {
                // Rozmiar rzeczywisty (usuń ograniczenia)
                imgEl.classList.remove('max-h-[95vh]', 'object-contain');
                imgEl.classList.add('max-h-none', 'max-w-none');
                btn.innerHTML = '<i class="fa-solid fa-compress mr-2"></i> Dopasuj do ekranu';
                window.isZoomed = true;
            }
        };

        window.changeLightboxImage = (direction) => {
            const images = window.currentLightboxImages; if(!images || images.length === 0) return;
            let newIndex = window.currentImgIndex + direction;
            if(newIndex >= images.length) newIndex = 0; if(newIndex < 0) newIndex = images.length - 1;
            window.currentImgIndex = newIndex;
            const imgEl = document.getElementById('lightbox-img'); const counterEl = document.getElementById('lightbox-counter');
            
            // Reset zoom przy zmianie zdjęcia
            if(window.isZoomed) window.toggleLightboxZoom();
            
            imgEl.style.opacity = 0.5;
            setTimeout(() => { imgEl.src = images[newIndex].src; counterEl.textContent = `${newIndex + 1} / ${images.length}`; imgEl.style.opacity = 1; }, 150);
        };

        window.closeLightbox = () => { const lb = document.getElementById('lightbox'); lb.classList.replace('opacity-100','opacity-0'); setTimeout(() => { lb.classList.add('hidden'); }, 300); };
        window.goHome = () => { 
            // Ukryj również legal-view
            document.getElementById('subcategory-view').classList.add('hidden'); document.getElementById('subcategories-full-view').classList.add('hidden'); document.getElementById('gallery-view').classList.add('hidden'); document.getElementById('custom-orders-full-view').classList.add('hidden'); document.getElementById('legal-view').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden'); document.getElementById('sub-categories-container').classList.add('hidden'); 
            document.querySelectorAll('.category-card-item').forEach(el => el.classList.remove('selected-category-border', 'border-wood-600', 'ring-4', 'ring-wood-200'));
            window.scrollTo(0,0);
        };
        
        // NOWE FUNKCJE OBSŁUGI DOKUMENTÓW PRAWNYCH
        window.openLegal = (type) => {
            const container = document.getElementById('legal-view');
            const titleEl = document.getElementById('legal-title');
            const contentEl = document.getElementById('legal-content');
            
            // Pobierz tekst z siteData lub initialData
            // Upewnij się, że obiekt istnieje
            const content = siteData.textContent || initialData.textContent;
            const legal = content.legal || initialData.textContent.legal;
            
            if (type === 'privacy') {
                titleEl.textContent = "Polityka Prywatności";
                contentEl.textContent = legal.privacy || "Brak treści.";
            } else if (type === 'terms') {
                titleEl.textContent = "Regulamin";
                contentEl.textContent = legal.terms || "Brak treści.";
            }
            
            document.getElementById('main-content').classList.add('hidden');
            // Ukryj inne widoki na wszelki wypadek
            document.getElementById('subcategory-view').classList.add('hidden');
            document.getElementById('gallery-view').classList.add('hidden');
            
            container.classList.remove('hidden');
            window.scrollTo(0,0);
        };

        window.closeLegal = () => {
            // Po prostu wróć do strony głównej
            window.goHome();
        };

        window.toggleMobileMenu = () => { document.getElementById('mobile-menu').classList.toggle('hidden'); };

        window.handleLogin = () => {
            const u = document.getElementById('login-user').value; const p = document.getElementById('login-pass').value;
            if(u === 'AdminXeons1308' && p === 'Ktymnyy5') { sessionStorage.setItem('xeomsc_admin', 'true'); location.reload(); } 
            else { document.getElementById('login-error').classList.remove('hidden'); }
        };
        window.handleLogout = () => { sessionStorage.removeItem('xeomsc_admin'); if(messageUnsubscribe) messageUnsubscribe(); location.reload(); };

        window.toggleAdminPanel = () => {
            const p = document.getElementById('admin-panel'); p.classList.toggle('hidden');
            if(!p.classList.contains('hidden')) window.switchAdminView('messages'); 
        };
        window.exitLogin = () => { document.getElementById('login-screen').classList.add('hidden'); window.location.hash = ''; };

        // --- FUNKCJE ADMINA ---
        window.switchAdminView = (id) => {
            document.querySelectorAll('.admin-view').forEach(v => v.classList.add('hidden'));
            document.querySelectorAll('.admin-sidebar-item').forEach(b => b.classList.remove('active'));
            const view = document.getElementById(`view-${id}`); if (view) view.classList.remove('hidden');
            const btn = document.getElementById(`btn-${id}`); if (btn) btn.classList.add('active');
            
            if (id === 'messages') { renderMessagesAdmin(); } 
            else if (id === 'hero-gallery') { renderHeroAdmin(); } 
            else if (id === 'categories') { renderCategoriesAdmin(); }
            else if (id === 'subcategories') { renderSubcategoriesAdmin(); }
            else if (id === 'products') { renderAddProductView(); } 
            else if (id === 'product-list') { renderProductListView(); }
            else if (id === 'custom-orders') { renderCustomOrdersAdmin(); }
            else if (id === 'content') {
                // AUTO-NAPRAWA STRUKTURY DANYCH (Jeśli brakuje nowych pól w bazie)
                if(!siteData.textContent) siteData.textContent = JSON.parse(JSON.stringify(initialData.textContent));
                if(!siteData.textContent.legal) siteData.textContent.legal = JSON.parse(JSON.stringify(initialData.textContent.legal));
                if(!siteData.textContent.footer) siteData.textContent.footer = JSON.parse(JSON.stringify(initialData.textContent.footer));
                
                const t = siteData.textContent;
                document.getElementById('edit-hero-main').value = t.hero.main || "";
                document.getElementById('edit-hero-accent').value = t.hero.accent || "";
                document.getElementById('edit-hero-desc').value = t.hero.desc || "";
                document.getElementById('edit-contact-email').value = t.contact.email || "";
                document.getElementById('edit-contact-phone').value = t.contact.phone || "";
                document.getElementById('edit-contact-desc').value = t.contact.desc || "";
                
                // Wypełnij pola prawne
                document.getElementById('edit-privacy').value = t.legal.privacy || "";
                document.getElementById('edit-terms').value = t.legal.terms || "";
                
                // Wypełnij pola stopki
                document.getElementById('edit-footer-slogan').value = t.footer.slogan || "";
                document.getElementById('edit-footer-copyright').value = t.footer.copyright || "";
                
                if(siteData.imgbbKey) document.getElementById('edit-imgbb-key').value = siteData.imgbbKey;
            }
            // NOWE: Dla kalkulatora nie potrzeba renderowania dynamicznego, formularz jest statyczny
        };
        
        // NOWA FUNKCJA KALKULATORA
        window.calculatePrice = () => {
            const material = parseFloat(document.getElementById('calc-material').value) || 0;
            const time = parseFloat(document.getElementById('calc-time').value) || 0;
            const rate = parseFloat(document.getElementById('calc-rate').value) || 0;
            const extra = parseFloat(document.getElementById('calc-extra').value) || 0;
            const margin = parseFloat(document.getElementById('calc-margin').value) || 0;

            // Koszt lasera = czas * (stawka / 60)
            const laserCost = time * (rate / 60);
            
            const baseCost = material + laserCost + extra;
            const finalPrice = baseCost * (1 + margin / 100);
            const profit = finalPrice - baseCost;

            document.getElementById('calc-final-price').textContent = finalPrice.toFixed(2) + ' PLN';
            document.getElementById('calc-base-cost').textContent = baseCost.toFixed(2);
            document.getElementById('calc-profit').textContent = profit.toFixed(2);
            
            document.getElementById('calc-result').classList.remove('hidden');
        };

        window.saveContentSettings = async () => {
            if(!siteData.textContent) siteData.textContent = initialData.textContent;
            if(!siteData.textContent.legal) siteData.textContent.legal = {};
            if(!siteData.textContent.footer) siteData.textContent.footer = {};

            siteData.textContent.hero.main = document.getElementById('edit-hero-main').value;
            siteData.textContent.hero.accent = document.getElementById('edit-hero-accent').value;
            siteData.textContent.hero.desc = document.getElementById('edit-hero-desc').value;
            siteData.textContent.contact.email = document.getElementById('edit-contact-email').value;
            siteData.textContent.contact.phone = document.getElementById('edit-contact-phone').value;
            siteData.textContent.contact.desc = document.getElementById('edit-contact-desc').value;
            
            // Zapisz dokumenty prawne
            siteData.textContent.legal.privacy = document.getElementById('edit-privacy').value;
            siteData.textContent.legal.terms = document.getElementById('edit-terms').value;
            
            // Zapisz stopkę
            siteData.textContent.footer.slogan = document.getElementById('edit-footer-slogan').value;
            siteData.textContent.footer.copyright = document.getElementById('edit-footer-copyright').value;
            
            siteData.imgbbKey = document.getElementById('edit-imgbb-key').value.trim();
            await saveData(); renderTexts(); showToast("Zapisano zmiany!");
        };

        function startMessageListener() {
             const list = document.getElementById('messages-list');
             const countBadge = document.getElementById('msg-count-bar');
             if(!isOnline) return;
             
             const msgCollection = collection(db, 'artifacts', appId, 'public', 'data', 'messages');
             if (messageUnsubscribe) messageUnsubscribe();
             
             messageUnsubscribe = onSnapshot(msgCollection, (snap) => {
                 let html = '';
                 let msgs = [];
                 snap.forEach(doc => { msgs.push({ id: doc.id, ...doc.data() }); });
                 msgs.sort((a,b) => new Date(b.date) - new Date(a.date)); 
                 
                 const unread = msgs.filter(m => (m.status === 'new' || (!m.read && !m.status))).length;
                 if(unread > 0) { countBadge.textContent = unread; countBadge.classList.remove('hidden'); } 
                 else { countBadge.classList.add('hidden'); }

                 if(msgs.length === 0) { html = '<p class="text-stone-500 text-center py-10">Brak wiadomości.</p>'; } 
                 else {
                     html = msgs.map(m => {
                         const isUnread = (m.status === 'new' || (!m.read && !m.status));
                         const statusKey = m.status || (m.read ? 'read' : 'new');
                         const statusData = STATUS_MAP[statusKey] || STATUS_MAP['new'];
                         const unreadClass = isUnread ? 'message-unread-header' : '';
                         const isOpen = window.openMessageIds.has(m.id); 

                         return `
                         <div class="message-row-wrapper">
                             <!-- HEADER: Kliknięcie otwiera wiadomość -->
                             <div class="message-row-header ${unreadClass}" onclick="window.toggleMessageBody('${m.id}')">
                                 <div><span class="status-badge ${statusData.class}">${statusData.label}</span></div>
                                 <div class="font-medium truncate">${m.name}</div>
                                 <div class="text-sm text-stone-400 truncate">${m.email}</div>
                                 <div class="text-right text-xs text-stone-500">${new Date(m.date).toLocaleString()}</div>
                                 
                                 <!-- AKCJE: KOSZ (Widoczny zawsze) -->
                                 <div class="text-right flex items-center justify-end gap-3">
                                     <button onclick="event.stopPropagation(); window.deleteMessage('${m.id}')" class="text-stone-500 hover:text-red-500 transition p-2" title="Usuń"><i class="fa-solid fa-trash"></i></button>
                                     <i class="fa-solid fa-chevron-down text-stone-600 transition-transform duration-300 transform ${isOpen ? 'rotate-180' : ''}"></i>
                                 </div>
                             </div>
                             
                             <!-- BODY (ACCORDION) -->
                             <div id="msg-body-${m.id}" class="msg-body-wrapper ${isOpen ? 'open' : ''}">
                                 <div class="p-6 space-y-4">
                                     <div>
                                         <p class="text-xs font-bold text-stone-500 uppercase mb-1">Treść wiadomości:</p>
                                         <p class="text-white text-sm whitespace-pre-wrap leading-relaxed">${m.message}</p>
                                     </div>
                                     
                                     ${m.attachment ? `
                                     <div>
                                         <p class="text-xs font-bold text-stone-500 uppercase mb-2">Załącznik:</p>
                                         <div class="flex flex-wrap items-end gap-4">
                                             <!-- Miniatura (Kliknij aby powiększyć w lightboxie z zoomem) -->
                                             <div class="relative group cursor-zoom-in max-w-xs" onclick="window.openMessageLightbox(this.querySelector('img').src)">
                                                 <img src="${m.attachment}" class="w-full max-h-64 object-contain rounded-lg border border-white/10 hover:opacity-90 transition bg-black/20">
                                                 <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition duration-300 pointer-events-none">
                                                     <span class="bg-black/60 text-white px-3 py-1 rounded-full text-xs backdrop-blur-sm"><i class="fa-solid fa-magnifying-glass-plus mr-1"></i> Powiększ</span>
                                                 </div>
                                             </div>
                                             
                                             <!-- Przycisk Pobierania ORYGINAŁU -->
                                             <a href="${m.attachment}" download="zalacznik_xeomsc_${m.id}.png" class="flex items-center gap-2 px-4 py-3 bg-stone-700 hover:bg-wood-600 text-white rounded-xl transition text-xs font-bold shadow-md group">
                                                 <i class="fa-solid fa-download group-hover:animate-bounce"></i> Pobierz oryginał
                                             </a>
                                         </div>
                                     </div>` : ''}

                                     <div class="pt-4 border-t border-white/5 flex flex-wrap items-center gap-4">
                                         <div class="flex items-center gap-2">
                                             <label class="text-xs font-bold text-stone-500 uppercase">Zmień status:</label>
                                             <select onchange="window.updateMessageStatus('${m.id}', this.value)" class="bg-black/40 border border-white/10 text-white text-xs rounded-lg px-3 py-2 outline-none focus:border-wood-500">
                                                 ${Object.keys(STATUS_MAP).map(k => `<option value="${k}" ${statusKey === k ? 'selected' : ''}>${STATUS_MAP[k].label}</option>`).join('')}
                                             </select>
                                         </div>
                                         <a href="mailto:${m.email}" class="text-xs font-bold text-wood-500 hover:text-wood-400 ml-auto flex items-center gap-2 px-4 py-2 bg-wood-500/10 rounded-lg hover:bg-wood-500/20 transition">
                                             <i class="fa-solid fa-reply"></i> Odpowiedz
                                         </a>
                                     </div>
                                 </div>
                             </div>
                         </div>
                      `;
                      }).join('');
                 }
                 if(list) list.innerHTML = html;
             }, (error) => {
                 console.error("Błąd pobierania wiadomości:", error);
                 if(list) list.innerHTML = '<p class="text-red-500 text-center py-10">Błąd połączenia z bazą wiadomości.</p>';
             });
        }
        
        window.toggleMessageBody = (id) => {
            const body = document.getElementById(`msg-body-${id}`);
            if (body) {
                const isOpen = body.classList.contains('open');
                
                if (!isOpen) {
                    // Otwieranie wiadomości
                    window.openMessageIds.add(id);
                    body.classList.add('open');

                    // Logika Auto-Read
                    const wrapper = body.closest('.message-row-wrapper');
                    const statusBadge = wrapper ? wrapper.querySelector('.status-new') : null;
                    
                    if (statusBadge) {
                        window.updateMessageStatus(id, 'read');
                    }
                } else {
                    // Zamykanie wiadomości
                    window.openMessageIds.delete(id);
                    body.classList.remove('open');
                }
            }
        };

        window.updateMessageStatus = async (id, newStatus) => {
            try {
                const isRead = newStatus !== 'new';
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'messages', id), {
                    status: newStatus,
                    read: isRead
                });
                showToast(`Status zmieniony na: ${STATUS_MAP[newStatus].label}`);
            } catch (e) {
                console.error(e);
                showToast("Błąd aktualizacji statusu");
            }
        };
        
        window.deleteMessage = async (id) => {
            window.openConfirm("Usunąć tę wiadomość?", async () => {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'messages', id));
                showToast("Wiadomość usunięta.");
            });
        };

        function renderMessagesAdmin() {
            const list = document.getElementById('messages-list');
            if(!auth.currentUser) { list.innerHTML = '<p class="text-center py-10">Brak dostępu.</p>'; return; }
            if(!isOnline) list.innerHTML = '<p class="text-stone-500 text-center py-10">Funkcja wiadomości wymaga połączenia.</p>';
        }

        function renderHeroAdmin() {
             const container = document.getElementById('view-hero-gallery');
             container.innerHTML = `
                <h3 class="text-3xl font-bold mb-6">Karuzela Hero</h3>
                <div class="bg-stone-800 p-6 rounded-3xl border border-white/5 space-y-4 mb-8">
                    <h4 class="text-xs uppercase font-bold text-stone-500">Dodaj nowy slajd</h4>
                    <input id="new-hero-url" class="calc-input" placeholder="Link do zdjęcia lub wideo">
                    <select id="new-hero-type" class="calc-input"><option value="image">Zdjęcie</option><option value="video">Wideo</option></select>
                    <button id="add-hero-btn" class="bg-wood-600 hover:bg-wood-500 w-full py-3 rounded-xl font-bold transition">Dodaj</button>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    ${siteData.heroItems.map((it, i) => `
                        <div class="relative group rounded-xl overflow-hidden aspect-video bg-black">
                            ${it.type === 'image' ? `<img src="${it.url}" class="w-full h-full object-cover">` : `<video src="${it.url}" class="w-full h-full object-cover"></video>`}
                            <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition flex items-center justify-center">
                                <button onclick="delHero(${i})" class="bg-red-600 text-white px-4 py-2 rounded-lg font-bold">USUŃ</button>
                            </div>
                        </div>`).join('')}
                </div>`;
             document.getElementById('add-hero-btn').onclick = () => {
                 const u = document.getElementById('new-hero-url').value; const t = document.getElementById('new-hero-type').value;
                 if(u) { siteData.heroItems.push({ id: Date.now(), type: t, url: u }); saveData(); renderHeroAdmin(); renderHero(); }
             };
        }

        function renderCategoriesAdmin() {
            const container = document.getElementById('view-categories');
            
            // SORTUJEMY KATEGORIE DO WYŚWIETLENIA W PANELU WG KOLEJNOŚCI
            const sortedCats = Object.entries(siteData.categories).sort(([, a], [, b]) => {
                const orderA = a.order !== undefined ? a.order : 9999;
                const orderB = b.order !== undefined ? b.order : 9999;
                return orderA - orderB;
            });

            container.innerHTML = `
                <h3 class="text-3xl font-bold mb-6">Kategorie Główne</h3>
                <div class="bg-stone-800 p-6 rounded-3xl border border-white/5 space-y-4 mb-8">
                    <h4 class="text-xs uppercase font-bold text-stone-500">Edytuj kategorię</h4>
                    <input type="hidden" id="edit-cat-id">
                    <input id="cat-t" class="calc-input" placeholder="Nazwa Kategorii">
                    <input id="cat-i" class="calc-input" placeholder="Link do zdjęcia">
                    <div class="flex gap-2">
                        <button id="add-cat-btn" class="bg-wood-600 hover:bg-wood-500 w-full py-3 rounded-xl font-bold transition">Utwórz</button>
                        <button id="cancel-cat-btn" class="hidden bg-stone-600 w-1/3 py-3 rounded-xl font-bold">Anuluj</button>
                    </div>
                </div>
                <div class="space-y-3">
                    ${sortedCats.map(([k, c]) => `
                        <div class="bg-black/40 p-4 rounded-xl flex justify-between items-center border border-white/5">
                            <span class="font-bold">${c.title}</span>
                            <div class="flex gap-2 items-center">
                                <!-- STRZAŁKI DO ZMIANY KOLEJNOŚCI -->
                                <button onclick="window.moveCategory('${k}', -1)" class="bg-stone-700 hover:bg-stone-600 w-8 h-8 rounded-lg flex items-center justify-center text-white text-xs transition mr-1" title="Przesuń wyżej"><i class="fa-solid fa-arrow-up"></i></button>
                                <button onclick="window.moveCategory('${k}', 1)" class="bg-stone-700 hover:bg-stone-600 w-8 h-8 rounded-lg flex items-center justify-center text-white text-xs transition mr-2" title="Przesuń niżej"><i class="fa-solid fa-arrow-down"></i></button>
                                
                                <button onclick="window.editCat('${k}')" class="text-blue-400 text-sm font-bold hover:text-white transition px-2">EDYTUJ</button>
                                <button onclick="window.delCat('${k}')" class="text-red-500 text-sm font-bold hover:text-white transition px-2">USUŃ</button>
                            </div>
                        </div>`).join('')}
                </div>`;
            document.getElementById('add-cat-btn').onclick = () => {
                const t = document.getElementById('cat-t').value; const i = document.getElementById('cat-i').value.trim(); const editId = document.getElementById('edit-cat-id').value;
                if(t) {
                    if (editId) { 
                        siteData.categories[editId].title = t; 
                        siteData.categories[editId].image = i; 
                    } else { 
                        const id = 'c' + Date.now(); 
                        // Nowa kategoria trafia na koniec
                        const maxOrder = Object.values(siteData.categories).reduce((max, c) => Math.max(max, c.order || 0), 0);
                        siteData.categories[id] = { title: t, image: i, subs: {}, isHidden: false, order: maxOrder + 1 }; 
                    }
                    saveData(); renderCategoriesAdmin(); renderMain();
                }
            };
            document.getElementById('cancel-cat-btn').onclick = () => { renderCategoriesAdmin(); };
        }
        
        // NOWA FUNKCJA DO ZMIANY KOLEJNOŚCI KATEGORII
        window.moveCategory = (id, direction) => {
            // 1. Pobierz posortowaną tablicę [key, object]
            const sortedCats = Object.entries(siteData.categories).sort(([, a], [, b]) => {
                const orderA = a.order !== undefined ? a.order : 9999;
                const orderB = b.order !== undefined ? b.order : 9999;
                return orderA - orderB;
            });

            // 2. Znajdź indeks elementu do przesunięcia
            const index = sortedCats.findIndex(([k]) => k === id);
            if (index === -1) return;

            // 3. Sprawdź czy ruch jest możliwy
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= sortedCats.length) return;

            // 4. Zamień elementy w tablicy
            const temp = sortedCats[index];
            sortedCats[index] = sortedCats[newIndex];
            sortedCats[newIndex] = temp;

            // 5. Przypisz nowe wartości 'order' wszystkim elementom (reindeksacja)
            sortedCats.forEach(([key], idx) => {
                siteData.categories[key].order = idx;
            });

            // 6. Zapisz i odśwież
            saveData();
            renderCategoriesAdmin();
            renderMain();
        };

        window.editCat = (id) => {
            const cat = siteData.categories[id];
            document.getElementById('cat-t').value = cat.title; document.getElementById('cat-i').value = cat.image;
            document.getElementById('edit-cat-id').value = id;
            document.getElementById('add-cat-btn').textContent = "Zapisz Zmiany"; document.getElementById('cancel-cat-btn').classList.remove('hidden');
        };

        function renderSubcategoriesAdmin() {
            const container = document.getElementById('view-subcategories');
            const cats = siteData.categories || {};
            
            // Sortowanie opcji w select (alfabetycznie)
            const categoryOptions = Object.keys(cats)
                .sort((a, b) => cats[a].title.localeCompare(cats[b].title, 'pl'))
                .map(k => `<option value="${k}">${cats[k].title}</option>`).join('');
            
            let subListHTML = '';
            
            // Sortowanie kategorii głównych (żeby grupy wyświetlały się w sensownej kolejności)
            const sortedCatKeys = Object.keys(cats).sort((a, b) => {
                const orderA = cats[a].order !== undefined ? cats[a].order : 9999;
                const orderB = cats[b].order !== undefined ? cats[b].order : 9999;
                return orderA - orderB;
            });
            
            // GENEROWANIE LISTY POGRUPOWANEJ
            sortedCatKeys.forEach(catId => {
                const cat = cats[catId];
                
                // Sprawdzamy, czy kategoria ma podkategorie
                if(cat.subs && Object.keys(cat.subs).length > 0) {
                    
                    // NAGŁÓWEK GRUPY (KATEGORIA GŁÓWNA)
                    subListHTML += `
                    <div class="mb-6 bg-stone-800/40 p-4 rounded-2xl border border-white/5">
                        <h4 class="text-wood-500 font-bold text-lg mb-3 flex items-center gap-2 border-b border-white/5 pb-2">
                            <i class="fa-solid fa-layer-group text-sm"></i> ${cat.title}
                        </h4>
                        <div class="space-y-2">
                    `;

                    // LISTA PODKATEGORII W TEJ GRUPIE
                    Object.keys(cat.subs)
                        .sort((a, b) => cat.subs[a].title.localeCompare(cat.subs[b].title, 'pl'))
                        .forEach(subId => {
                            const sub = cat.subs[subId];
                            
                            // Wyświetlanie miniatury
                            const imgHtml = sub.image 
                                ? `<img src="${sub.image}" onerror="this.src='https://via.placeholder.com/40?text=ERR'; this.onerror=null;" class="w-10 h-10 rounded object-cover border border-white/10 bg-white/5 shrink-0">` 
                                : `<div class="w-10 h-10 rounded bg-white/5 flex items-center justify-center text-white/20 text-xs shrink-0"><i class="fa-solid fa-image"></i></div>`;

                            subListHTML += `
                            <div class="bg-black/40 p-3 rounded-xl flex justify-between items-center border border-white/5 hover:border-wood-600/30 transition group">
                                <div class="flex items-center gap-3 overflow-hidden">
                                    ${imgHtml}
                                    <div class="min-w-0">
                                        <!-- Usunięto nazwę kategorii nadrzędnej z pojedynczego elementu, bo jest w nagłówku grupy -->
                                        <span class="font-bold text-sm text-stone-200 truncate block group-hover:text-wood-500 transition">${sub.title}</span>
                                        <span class="text-[10px] text-stone-500 block">${sub.products ? sub.products.length : 0} produktów</span>
                                    </div>
                                </div>
                                <div class="flex gap-2 shrink-0">
                                    <button onclick="window.editSubCat('${catId}', '${subId}')" class="text-blue-400 text-xs font-bold hover:text-white transition px-3 py-2 bg-blue-400/10 rounded-lg hover:bg-blue-600 hover:shadow-lg hover:scale-105 transform duration-200">EDYTUJ</button>
                                    <button onclick="window.delSubCat('${catId}', '${subId}')" class="text-red-500 text-xs font-bold hover:text-white transition px-3 py-2 bg-red-500/10 rounded-lg hover:bg-red-600 hover:shadow-lg hover:scale-105 transform duration-200">USUŃ</button>
                                </div>
                            </div>`;
                        });

                    // ZAMKNIĘCIE GRUPY
                    subListHTML += `</div></div>`;
                }
            });

            container.innerHTML = `
                <h3 class="text-3xl font-bold mb-6">Podkategorie</h3>
                
                <!-- Formularz dodawania -->
                <div class="bg-stone-800 p-6 rounded-3xl border border-white/5 space-y-4 mb-8 shadow-xl">
                    <h4 class="text-xs uppercase font-bold text-stone-500" id="sub-form-title">Dodaj Podkategorię</h4>
                    
                    <!-- Ukryte pola do edycji -->
                    <input type="hidden" id="edit-sub-cat-id">
                    <input type="hidden" id="edit-sub-parent-id">
                    
                    <select id="new-sub-cat-parent" class="calc-input text-white font-bold"><option value="">-- Wybierz Kategorię Główną --</option>${categoryOptions}</select>
                    <input id="sub-t" class="calc-input" placeholder="Nazwa Podkategorii">
                    <input id="sub-i" class="calc-input" placeholder="Link do zdjęcia podkategorii">
                    
                    <div class="flex gap-2">
                        <button id="add-sub-btn" class="bg-wood-600 hover:bg-wood-500 w-full py-3 rounded-xl font-bold transition shadow-lg">Utwórz Podkategorię</button>
                        <button id="cancel-sub-btn" class="hidden bg-stone-600 w-1/3 py-3 rounded-xl font-bold shadow-lg">Anuluj</button>
                    </div>
                </div>
                
                <h4 class="text-xl font-bold mb-4">Lista Podkategorii (wg Grup)</h4>
                
                <!-- Lista pogrupowana -->
                <div class="space-y-1 pb-10">
                    ${subListHTML || '<p class="text-stone-500 text-center py-8 bg-stone-900/50 rounded-2xl border border-white/5">Brak podkategorii. Dodaj pierwszą powyżej.</p>'}
                </div>`;
            
            document.getElementById('add-sub-btn').onclick = () => {
                const parentId = document.getElementById('new-sub-cat-parent').value; 
                const t = document.getElementById('sub-t').value; 
                const i = document.getElementById('sub-i').value.trim(); // Trim added
                
                // Dane do edycji
                const editSubId = document.getElementById('edit-sub-cat-id').value;
                const oldParentId = document.getElementById('edit-sub-parent-id').value;

                if(parentId && t) {
                    if (editSubId) {
                        // TRYB EDYCJI
                        // Sprawdzamy czy zmieniono kategorię nadrzędną
                        if (oldParentId && oldParentId !== parentId) {
                            // 1. Pobierz produkty i dane ze starej lokalizacji
                            const products = siteData.categories[oldParentId].subs[editSubId].products || [];
                            
                            // 2. Usuń ze starej kategorii
                            delete siteData.categories[oldParentId].subs[editSubId];
                            
                            // 3. Dodaj do nowej kategorii (zachowując ID podkategorii)
                            if(!siteData.categories[parentId].subs) siteData.categories[parentId].subs = {};
                            siteData.categories[parentId].subs[editSubId] = { title: t, image: i, products: products };
                        } else {
                            // Tylko aktualizacja danych w tej samej kategorii
                            siteData.categories[parentId].subs[editSubId].title = t;
                            siteData.categories[parentId].subs[editSubId].image = i;
                        }
                        showToast("Zapisano zmiany w podkategorii!");
                    } else {
                        // TRYB DODAWANIA NOWEJ
                        const subId = 's' + Date.now();
                        if(!siteData.categories[parentId].subs) siteData.categories[parentId].subs = {};
                        siteData.categories[parentId].subs[subId] = { title: t, image: i, products: [] };
                        showToast("Podkategoria dodana!");
                    }
                    saveData(); 
                    renderSubcategoriesAdmin(); 
                    renderMain(); // ODŚWIEŻ STRONĘ GŁÓWNĄ, ABY POKAZAĆ NOWE ZDJĘCIA
                } else { showToast("Wybierz kategorię nadrzędną i wpisz nazwę."); }
            };
            
            document.getElementById('cancel-sub-btn').onclick = () => {
                renderSubcategoriesAdmin(); // Reset formularza
            };
        }
        
        // NOWA FUNKCJA DO EDYCJI PODKATEGORII
        window.editSubCat = (parentId, subId) => {
            const sub = siteData.categories[parentId].subs[subId];
            if(!sub) return;
            
            // Wypełnij formularz
            document.getElementById('new-sub-cat-parent').value = parentId;
            document.getElementById('sub-t').value = sub.title;
            document.getElementById('sub-i').value = sub.image;
            
            // Ustaw flagi edycji
            document.getElementById('edit-sub-cat-id').value = subId;
            document.getElementById('edit-sub-parent-id').value = parentId;
            
            // Zmień wygląd
            document.getElementById('sub-form-title').textContent = "Edytuj Podkategorię";
            document.getElementById('add-sub-btn').textContent = "Zapisz Zmiany";
            document.getElementById('cancel-sub-btn').classList.remove('hidden');
            
            // Przewiń do góry panelu
            document.getElementById('admin-content-area').scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.delSubCat = (catId, subId) => { window.openConfirm("Usunąć podkategorię?", () => { delete siteData.categories[catId].subs[subId]; saveData(); renderSubcategoriesAdmin(); renderMain(); }); };

        function renderAddProductView() {
            const container = document.getElementById('view-products');
            const cats = siteData.categories || {};
            const categoryOptions = Object.keys(cats).map(k => `<option value="${k}">${cats[k].title}</option>`).join('');
            container.innerHTML = `
                <h3 class="text-3xl font-bold mb-6">Dodaj Nowe Produkty</h3>
                <div class="bg-stone-800 p-6 rounded-3xl border border-white/5 space-y-4 mb-8">
                    <h4 class="text-xs uppercase font-bold text-wood-500"><i class="fa-solid fa-plus"></i> Nowy Produkt</h4>
                    <div><label class="text-[10px] uppercase font-bold text-stone-500">Kategoria Główna</label><select id="new-p-cat" class="calc-input text-white font-bold" onchange="updateSubSelectForAdd()"><option value="">-- Wybierz --</option>${categoryOptions}</select></div>
                    <div><label class="text-[10px] uppercase font-bold text-stone-500">Podkategoria</label><select id="new-p-sub" class="calc-input text-white font-bold" disabled><option value="">-- Najpierw wybierz kategorię --</option></select></div>
                    <input id="new-p-t" class="calc-input" placeholder="Nazwa produktu">
                    <div class="grid grid-cols-2 gap-4"><input id="new-p-code" class="calc-input" placeholder="Kod produktu"><input id="new-p-price" class="calc-input" placeholder="Cena"></div>
                    <textarea id="new-p-desc" class="calc-input h-24" placeholder="Opis"></textarea>
                    
                    <div>
                        <input id="new-p-i" class="calc-input" placeholder="Miniatura (Główne zdjęcie)">
                        <p class="text-[10px] text-stone-500 mt-1 italic">(Jeśli zostawisz puste, zostanie użyte pierwsze zdjęcie z galerii poniżej)</p>
                    </div>

                    <div class="pt-4 border-t border-white/5"><label class="block text-xs font-bold text-stone-500 uppercase mb-2">Zdjęcia do galerii</label><div id="new-gallery-container" class="space-y-2"><input class="calc-input gallery-input" placeholder="Link do zdjęcia" oninput="addGalleryInput(this)"></div></div>
                    <button id="btn-add-prod" class="bg-wood-600 hover:bg-wood-500 w-full py-4 rounded-xl font-bold transition mt-4">Dodaj Produkt</button>
                </div>`;
            
            document.getElementById('btn-add-prod').onclick = () => {
                const cid = document.getElementById('new-p-cat').value; const sid = document.getElementById('new-p-sub').value;
                const t = document.getElementById('new-p-t').value; 
                let img = document.getElementById('new-p-i').value.trim(); // Trim added
                
                const code = document.getElementById('new-p-code').value; const price = document.getElementById('new-p-price').value;
                const desc = document.getElementById('new-p-desc').value;
                
                if(cid && sid && t) {
                    const prodId = 'p' + Date.now();
                    const galleryInputs = document.querySelectorAll('#new-gallery-container .gallery-input');
                    const galleryImages = []; 
                    galleryInputs.forEach(inp => { if(inp.value.trim() !== '') galleryImages.push({ src: inp.value.trim() }); });
                    
                    // --- AUTO-MINIATURA FIX ---
                    // Jeśli nie podano miniatury, weź pierwsze zdjęcie z galerii
                    if (!img && galleryImages.length > 0) {
                        img = galleryImages[0].src;
                    }

                    if(!siteData.categories[cid].subs[sid].products) siteData.categories[cid].subs[sid].products = [];
                    siteData.categories[cid].subs[sid].products.push({ id: prodId, title: t, image: img, code: code, price: price, desc: desc, isHidden: false });
                    siteData.galleries[prodId] = { images: galleryImages };
                    saveData(); showToast("Produkt dodany!"); renderAddProductView();
                } else { showToast("Wybierz kategorię, podkategorię i podaj nazwę produktu."); }
            };
        }

        window.updateSubSelectForAdd = () => {
            const cid = document.getElementById('new-p-cat').value; const subSelect = document.getElementById('new-p-sub');
            subSelect.innerHTML = '<option value="">-- Wybierz Podkategorię --</option>';
            if(cid && siteData.categories[cid].subs) {
                const subs = siteData.categories[cid].subs;
                // SORTOWANIE ALFABETYCZNE W DROPDOWNIE
                Object.keys(subs)
                    .sort((a, b) => subs[a].title.localeCompare(subs[b].title, 'pl'))
                    .forEach(sid => { 
                        const opt = document.createElement('option'); 
                        opt.value = sid; 
                        // DODANO LICZNIK PRODUKTÓW
                        const count = subs[sid].products ? subs[sid].products.length : 0;
                        opt.text = `${subs[sid].title} (${count})`; 
                        subSelect.appendChild(opt); 
                    });
                subSelect.disabled = false;
            } else { subSelect.disabled = true; }
        };

        window.addGalleryInput = (el) => {
            if(el.value.trim() !== '' && el === el.parentElement.lastElementChild) {
                const newInput = document.createElement('input'); newInput.className = "calc-input gallery-input animate-fade-in"; newInput.placeholder = "Link do zdjęcia"; newInput.oninput = function() { window.addGalleryInput(this); }; el.parentElement.appendChild(newInput);
            }
        };

        window.renderProductListView = () => {
            const container = document.getElementById('view-product-list');
            const cats = siteData.categories || {};
            const categoryOptions = Object.keys(cats).map(k => `<option value="${k}">${cats[k].title}</option>`).join('');
            container.innerHTML = `
                <h3 class="text-3xl font-bold mb-6">Lista Produktów</h3>
                <div class="bg-stone-800 p-6 rounded-3xl border border-white/5 space-y-4 mb-8">
                      <select id="list-cat-select" class="calc-input" onchange="window.onSelectListCategory()"><option value="">-- Wybierz Kategorię --</option>${categoryOptions}</select>
                      <select id="list-sub-select" class="calc-input hidden" onchange="window.onSelectListSubcategory()"><option value="">-- Wybierz Podkategorię --</option></select>
                      <select id="list-prod-select" class="calc-input hidden" onchange="window.onSelectListProduct()"><option value="">-- Wybierz Produkt --</option></select>
                </div>
                <div id="list-actions" class="hidden flex gap-2 mb-6">
                    <button id="btn-toggle-hide" onclick="window.toggleHideProduct()" class="bg-stone-600 hover:bg-stone-500 px-6 py-2 rounded-lg font-bold transition">Ukryj</button>
                    <button onclick="window.editProductFromList()" class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded-lg font-bold transition">Edytuj</button>
                    <button onclick="window.deleteProductFromList()" class="bg-red-600 hover:bg-red-500 px-6 py-2 rounded-lg font-bold transition">Usuń</button>
                </div>
                <div id="list-edit-form" class="hidden bg-stone-800 p-6 rounded-3xl border border-white/5 space-y-4">
                    <h4 class="text-xs uppercase font-bold text-blue-400">Edycja Produktu</h4>
                    <input id="edit-p-t" class="calc-input">
                    <div class="grid grid-cols-2 gap-4"><input id="edit-p-code" class="calc-input"><input id="edit-p-price" class="calc-input"></div>
                    <textarea id="edit-p-desc" class="calc-input h-24"></textarea>
                    
                    <div>
                         <input id="edit-p-i" class="calc-input">
                         <p class="text-[10px] text-stone-500 mt-1 italic">(Jeśli zostawisz puste, zostanie użyte pierwsze zdjęcie z galerii poniżej)</p>
                    </div>

                    <div class="pt-4 border-t border-white/5"><label class="block text-xs font-bold text-stone-500 uppercase mb-2">Zdjęcia galerii</label><div id="edit-gallery-container" class="space-y-2"></div></div>
                    <button onclick="window.saveEditedProduct()" class="bg-green-600 hover:bg-green-500 w-full py-4 rounded-xl font-bold transition">Zapisz Zmiany</button>
                </div>`;
        };

        window.onSelectListCategory = () => {
            const catId = document.getElementById('list-cat-select').value; window.selectedListCatId = catId; window.selectedListSubId = null;
            const subSelect = document.getElementById('list-sub-select'); const prodSelect = document.getElementById('list-prod-select');
            subSelect.classList.add('hidden'); prodSelect.classList.add('hidden'); document.getElementById('list-actions').classList.add('hidden'); document.getElementById('list-edit-form').classList.add('hidden');
            if(catId && siteData.categories[catId].subs) {
                subSelect.innerHTML = '<option value="">-- Wybierz Podkategorię --</option>';
                const subs = siteData.categories[catId].subs;
                // SORTOWANIE ALFABETYCZNE W DROPDOWNIE
                Object.keys(subs)
                    .sort((a, b) => subs[a].title.localeCompare(subs[b].title, 'pl'))
                    .forEach(sid => { 
                        const opt = document.createElement('option'); 
                        opt.value = sid; 
                        // DODANO LICZNIK PRODUKTÓW
                        const count = subs[sid].products ? subs[sid].products.length : 0;
                        opt.text = `${subs[sid].title} (${count})`; 
                        subSelect.appendChild(opt); 
                    });
                subSelect.classList.remove('hidden');
            }
        };

        window.onSelectListSubcategory = () => {
            const catId = window.selectedListCatId; const subId = document.getElementById('list-sub-select').value; window.selectedListSubId = subId;
            const prodSelect = document.getElementById('list-prod-select'); prodSelect.classList.add('hidden'); document.getElementById('list-actions').classList.add('hidden'); document.getElementById('list-edit-form').classList.add('hidden');
            if(subId && siteData.categories[catId].subs[subId].products) {
                prodSelect.innerHTML = '<option value="">-- Wybierz Produkt --</option>';
                const products = siteData.categories[catId].subs[subId].products;
                products.forEach((p, index) => { const opt = document.createElement('option'); opt.value = index; opt.text = `${p.title} ${p.isHidden ? '(UKRYTY)' : ''}`; prodSelect.appendChild(opt); });
                prodSelect.classList.remove('hidden');
            }
        };

        window.onSelectListProduct = () => {
            const index = document.getElementById('list-prod-select').value; window.selectedListProdIndex = index;
            const actions = document.getElementById('list-actions'); const editForm = document.getElementById('list-edit-form');
            actions.classList.add('hidden'); editForm.classList.add('hidden');
            if (index === "") return;
            const product = siteData.categories[window.selectedListCatId].subs[window.selectedListSubId].products[index];
            const btnHide = document.getElementById('btn-toggle-hide');
            if(product.isHidden) { btnHide.innerHTML = '<i class="fa-regular fa-eye"></i> Pokaż'; btnHide.classList.replace('bg-stone-600', 'bg-green-600'); } 
            else { btnHide.innerHTML = '<i class="fa-regular fa-eye-slash"></i> Ukryj'; btnHide.classList.replace('bg-green-600', 'bg-stone-600'); }
            actions.classList.remove('hidden');
        };

        window.toggleHideProduct = () => {
            const catId = window.selectedListCatId; const subId = window.selectedListSubId; const index = window.selectedListProdIndex;
            const product = siteData.categories[catId].subs[subId].products[index];
            product.isHidden = !product.isHidden; saveData();
            const prodSelect = document.getElementById('list-prod-select'); prodSelect.options[prodSelect.selectedIndex].text = `${product.title} ${product.isHidden ? '(UKRYTY)' : ''}`; window.onSelectListProduct();
        };

        window.deleteProductFromList = () => {
            window.openConfirm("Czy na pewno chcesz usunąć ten produkt?", () => {
                const catId = window.selectedListCatId; const subId = window.selectedListSubId; const index = window.selectedListProdIndex;
                siteData.categories[catId].subs[subId].products.splice(index, 1);
                saveData(); window.onSelectListSubcategory(); 
            });
        };

        window.editProductFromList = () => {
            const catId = window.selectedListCatId; const subId = window.selectedListSubId; const index = window.selectedListProdIndex;
            const product = siteData.categories[catId].subs[subId].products[index]; const form = document.getElementById('list-edit-form'); const prodId = product.id;
            document.getElementById('edit-p-t').value = product.title; document.getElementById('edit-p-code').value = product.code || ''; document.getElementById('edit-p-price').value = product.price || ''; document.getElementById('edit-p-desc').value = product.desc || ''; document.getElementById('edit-p-i').value = product.image;
            const galContainer = document.getElementById('edit-gallery-container'); galContainer.innerHTML = '';
            const currentGallery = siteData.galleries[prodId] ? siteData.galleries[prodId].images : [];
            currentGallery.forEach(img => { const inp = document.createElement('input'); inp.className = "calc-input gallery-input"; inp.value = img.src; inp.oninput = function() { window.addGalleryInput(this); }; galContainer.appendChild(inp); });
            const emptyInp = document.createElement('input'); emptyInp.className = "calc-input gallery-input"; emptyInp.placeholder = "Link do zdjęcia"; emptyInp.oninput = function() { window.addGalleryInput(this); }; galContainer.appendChild(emptyInp);
            form.classList.remove('hidden'); form.scrollIntoView({ behavior: 'smooth' });
        };

        window.saveEditedProduct = () => {
            const catId = window.selectedListCatId; const subId = window.selectedListSubId; const index = window.selectedListProdIndex;
            const product = siteData.categories[catId].subs[subId].products[index]; const prodId = product.id;
            product.title = document.getElementById('edit-p-t').value; product.code = document.getElementById('edit-p-code').value; product.price = document.getElementById('edit-p-price').value; product.desc = document.getElementById('edit-p-desc').value; 
            
            let img = document.getElementById('edit-p-i').value.trim(); // Trim added

            const galleryInputs = document.querySelectorAll('#edit-gallery-container .gallery-input');
            const galleryImages = []; galleryInputs.forEach(inp => { if(inp.value.trim() !== '') galleryImages.push({ src: inp.value.trim() }); });
            
            // --- AUTO-MINIATURA FIX W EDYCJI ---
            if (!img && galleryImages.length > 0) {
                img = galleryImages[0].src;
            }
            product.image = img;

            siteData.galleries[prodId] = { images: galleryImages };
            saveData(); showToast("Zapisano zmiany!"); document.getElementById('list-edit-form').classList.add('hidden');
            const prodSelect = document.getElementById('list-prod-select'); prodSelect.options[prodSelect.selectedIndex].text = `${product.title} ${product.isHidden ? '(UKRYTY)' : ''}`;
        };

        function renderCustomOrdersAdmin() {
            const container = document.getElementById('admin-custom-orders-list'); const orders = siteData.customOrders || [];
            if (container) {
                container.innerHTML = orders.map((url, i) => `<div class="relative group aspect-square rounded-xl overflow-hidden"><img src="${url}" class="w-full h-full object-cover"><div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition flex items-center justify-center"><button onclick="deleteCustomOrder(${i})" class="bg-red-600 text-white px-3 py-1 rounded text-xs font-bold">USUŃ</button></div></div>`).join('');
            }
        }
        
        window.saveCustomOrders = () => {
            const inputs = document.querySelectorAll('#custom-orders-input-container .gallery-input'); let added = false;
            inputs.forEach(inp => { if(inp.value.trim()) { if(!siteData.customOrders) siteData.customOrders = []; siteData.customOrders.push(inp.value.trim()); inp.value = ''; added = true; } });
            if(added) { saveData(); renderCustomOrdersAdmin(); renderMain(); showToast('Dodano zdjęcia!'); }
        };

        window.deleteCustomOrder = (index) => { window.openConfirm('Usunąć to zdjęcie?', () => { siteData.customOrders.splice(index, 1); saveData(); renderCustomOrdersAdmin(); renderMain(); }); };

        // --- KONTAKT MODALS ---
        window.openContactModal = (code = '', imageUrl = '') => {
             document.getElementById('contact-modal').classList.remove('hidden'); 
             document.getElementById('product-codes-section').classList.remove('hidden'); 
             
             // Ukrywamy upload użytkownika, bo załączamy zdjęcie produktu automatycznie
             // Jeśli chcesz pozwolić użytkownikowi zmienić zdjęcie, usuń tę linię, ale wtedy trzeba obsłużyć logikę priorytetów
             document.getElementById('contact-upload-section').classList.add('hidden'); 
             
             // Zapisujemy URL zdjęcia do zmiennej globalnej
             window.currentContactProductImage = imageUrl;

             const container = document.getElementById('product-codes-container'); 
             
             // Generujemy HTML z miniaturką zdjęcia i kodem
             let imgHtml = imageUrl ? `<img src="${imageUrl}" class="w-16 h-16 object-cover rounded-lg border border-stone-200 bg-white shadow-sm shrink-0">` : '';
             
             container.innerHTML = `
                <div class="flex items-center gap-4 p-2 bg-stone-50 rounded-xl border border-stone-100">
                    ${imgHtml}
                    <div class="flex-1 overflow-hidden">
                        <label class="block text-[10px] font-bold text-stone-400 uppercase mb-1">Dotyczy produktu</label>
                        <input type="text" id="code-input-0" class="w-full bg-transparent font-mono font-bold text-stone-800 text-sm outline-none truncate" readonly value="${code || 'Produkt bez kodu'}">
                    </div>
                </div>`;
             
             document.getElementById('contact-message').value = code ? `Dzień dobry, interesuje mnie produkt o kodzie ${code}. Proszę o informację o dostępności.` : '';
        };

        window.openGeneralContactModal = () => {
             // Resetujemy zdjęcie produktu przy ogólnym kontakcie
             window.currentContactProductImage = null;
             document.getElementById('contact-modal').classList.remove('hidden'); 
             document.getElementById('product-codes-section').classList.add('hidden'); 
             document.getElementById('contact-upload-section').classList.remove('hidden'); 
             document.getElementById('contact-message').value = '';
        };

        window.closeContactModal = () => { 
            document.getElementById('contact-modal').classList.add('hidden'); 
            window.currentContactProductImage = null; // Czyścimy po zamknięciu
        };

        window.submitContactForm = async () => {
             const btn = document.getElementById('submit-contact-btn');
             const nameInp = document.getElementById('contact-name');
             const name = nameInp.value.trim();
             const emailInp = document.getElementById('contact-email-input');
             const email = emailInp.value.trim();
             const msgInp = document.getElementById('contact-message');
             const msg = msgInp.value.trim();
             const fileInput = document.getElementById('contact-file-input');
             const file = fileInput.files[0];

             // Reset stylów błędów
             [nameInp, emailInp, msgInp].forEach(el => el.classList.remove('border-red-500', 'ring-2', 'ring-red-200'));

             // 1. Walidacja Imienia (min 3 znaki)
             if(name.length < 3) {
                 showToast("Podaj swoje pełne imię (min. 3 znaki)!");
                 nameInp.classList.add('border-red-500', 'ring-2', 'ring-red-200');
                 setTimeout(() => nameInp.classList.remove('border-red-500', 'ring-2', 'ring-red-200'), 3000);
                 nameInp.focus();
                 return;
             }

             // 2. Walidacja Emaila (Regex)
             const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/;
             if (!emailRegex.test(email)) {
                 showToast("Wprowadź poprawny adres email (np. jan@domena.pl)!");
                 emailInp.classList.add('border-red-500', 'ring-2', 'ring-red-200');
                 setTimeout(() => emailInp.classList.remove('border-red-500', 'ring-2', 'ring-red-200'), 3000);
                 emailInp.focus();
                 return;
             }

             // 3. Walidacja Treści (min 10 znaków)
             if(msg.length < 10) {
                 showToast("Wiadomość jest zbyt krótka (min. 10 znaków)!");
                 msgInp.classList.add('border-red-500', 'ring-2', 'ring-red-200');
                 setTimeout(() => msgInp.classList.remove('border-red-500', 'ring-2', 'ring-red-200'), 3000);
                 msgInp.focus();
                 return;
             }

             // Zabezpieczenie przed zbyt dużym plikiem (limit 1MB dla bezpieczeństwa Firestore)
             if(file && file.size > 1024 * 1024) {
                 alert("Plik jest za duży! Maksymalny rozmiar to 1MB.");
                 return;
             }

             const originalText = btn.innerHTML;
             btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Wysyłanie...';
             
             try {
                let attachmentData = null;
                
                // Priorytet 1: Plik wgrany przez użytkownika (jeśli dostępny)
                if (file) {
                    attachmentData = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                } 
                // Priorytet 2: Automatyczne zdjęcie produktu (jeśli brak pliku użytkownika)
                else if (window.currentContactProductImage) {
                    attachmentData = window.currentContactProductImage;
                }

                if(isOnline) {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
                        name: name, 
                        email: email, 
                        message: msg, 
                        attachment: attachmentData,
                        date: new Date().toISOString(), 
                        status: 'new', // Domyślny status
                        read: false
                    });
                    btn.innerHTML = '<i class="fa-solid fa-check"></i> Wysłano!';
                    setTimeout(() => { 
                        btn.innerHTML = originalText; 
                        closeContactModal(); 
                        showToast("Wiadomość wysłana!");
                        document.getElementById('contact-file-input').value = ""; // Reset inputu
                    }, 1500);
                } else {
                    alert("Jesteś offline. Nie można wysłać wiadomości.");
                    btn.innerHTML = originalText;
                }
             } catch(e) {
                 console.error(e);
                 alert("Błąd wysyłania: " + e.message);
                 btn.innerHTML = originalText;
             }
        };

        // --- STARTUP ---
        function updateStatusUI(online, message = "") {
            isOnline = online;
            const dot = document.getElementById('status-dot'); const txt = document.getElementById('status-text'); const banner = document.getElementById('error-banner');
            if(online) {
                dot.className = "status-dot status-online"; txt.textContent = "ONLINE (CHMURA)";
                txt.classList.add('text-green-400'); txt.classList.remove('text-stone-400'); banner.style.display = 'none';
            } else {
                dot.className = "status-dot status-offline"; txt.textContent = "OFFLINE (BŁĄD)";
                txt.classList.add('text-red-400'); txt.classList.remove('text-green-400');
                if(message) { lastError = message; banner.textContent = "BŁĄD POŁĄCZENIA: " + message; banner.style.display = 'block'; }
            }
        }
        
        window.showDetailedError = () => { if(lastError) alert("Ostatni błąd:\n" + lastError); else showToast("Połączenie aktywne."); };
        function updateDataSourceIndicator(source, isError=false) {
            const el = document.getElementById('data-source-indicator');
        }

        async function saveData() {
            try {
                siteData.categories = siteData.categories || {};
                localStorage.setItem('xeomsc_cached_data', JSON.stringify(siteData));
                if(isOnline && auth && auth.currentUser) {
                    await setDoc(doc(db, `artifacts/${appId}/public/data/siteConfig`, 'main'), siteData);
                    console.log("Zapisano w chmurze");
                }
            } catch(e) { console.error("Błąd zapisu", e); showToast("Błąd zapisu!"); }
        }

        async function start() {
            if(sessionStorage.getItem('xeomsc_admin') === 'true') { 
                document.body.classList.add('is-admin'); document.getElementById('admin-bar').classList.remove('hidden'); 
            } else if(window.location.hash === '#admin') { document.getElementById('login-screen').classList.remove('hidden'); }
            window.addEventListener('hashchange', () => { if(window.location.hash === '#admin') document.getElementById('login-screen').classList.remove('hidden'); });

            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    const appObj = initializeApp(firebaseConfig);
                    auth = getAuth(appObj);
                    db = getFirestore(appObj);
                    try { if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } else { await signInAnonymously(auth); } } catch (authError) { updateStatusUI(false, authError.message); return; }

                    onAuthStateChanged(auth, (u) => {
                        if(u) {
                            updateStatusUI(true);
                            if(sessionStorage.getItem('xeomsc_admin') === 'true') { startMessageListener(); }
                            onSnapshot(doc(db, `artifacts/${appId}/public/data/siteConfig`, 'main'), (snap) => {
                                if (snap.exists()) {
                                    siteData = snap.data();
                                    updateDataSourceIndicator('cloud');
                                    if(!siteData.textContent) siteData.textContent = initialData.textContent;
                                    localStorage.setItem('xeomsc_cached_data', JSON.stringify(siteData));
                                    renderHero(); renderMain(); renderTexts();
                                    if(!document.getElementById('admin-panel').classList.contains('hidden')) { 
                                        if(siteData.imgbbKey && document.getElementById('edit-imgbb-key')) { document.getElementById('edit-imgbb-key').value = siteData.imgbbKey; } 
                                    }
                                } else { 
                                    if(sessionStorage.getItem('xeomsc_admin') === 'true') { saveData(); } 
                                    else { updateDataSourceIndicator('local'); } 
                                }
                            }, (error) => { console.error("Snapshot error:", error); updateStatusUI(false, error.message); updateDataSourceIndicator('local', true); });
                        }
                    });
                } else { updateStatusUI(false, "Brak konfiguracji Firebase"); updateDataSourceIndicator('local'); }
            } catch (e) { console.log("Tryb offline", e); updateStatusUI(false, e.message); updateDataSourceIndicator('local', true); renderHero(); renderMain(); renderTexts(); }
        }

        siteData = JSON.parse(localStorage.getItem('xeomsc_cached_data')) || initialData;
        renderHero(); renderMain(); renderTexts(); start();
    </script>
</body>
</html>